<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persiche Ecke POS</title>
    
    <!-- Firebase App (core) - SIMPLE VERSION WITH NO APP CHECK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        order: '#3b82f6',
                        kitchen: '#ef4444',
                        completed: '#10b981',
                        config: '#8b5cf6',
                        food: '#e67e22',
                        beverage: '#3498db',
                        dessert: '#9b59b6'
                    }
                }
            },
            darkMode: 'class',
        }
    </script>
    <style>
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Category headings */
        .category-heading {
            @apply text-lg font-semibold mb-2 mt-4 border-b pb-1;
        }
        
        .food-heading {
            @apply text-food border-food/30;
        }
        
        .beverage-heading {
            @apply text-beverage border-beverage/30;
        }
        
        .dessert-heading {
            @apply text-dessert border-dessert/30;
        }
        
        /* Connection status badge */
        #connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 1000;
        }
        
        .status-online {
            background-color: #10b981;
            color: white;
        }
        
        .status-offline {
            background-color: #ef4444;
            color: white;
        }
        
        /* Loading indicator */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen transition-colors duration-200">
    
    <!-- Connection Status Indicator -->
    <div id="connection-status" class="status-offline">
        <span id="status-text">Offline Mode</span>
        <button id="retry-connection" class="ml-2 bg-white bg-opacity-20 px-2 py-1 rounded text-sm">
            Retry
        </button>
    </div>

    <!-- Authentication Section - FIXED: Removed duplicate login forms -->
    <div id="auth-section" class="max-w-sm mx-auto p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg mt-10">
        <h2 class="text-xl font-semibold mb-4 text-center">Login</h2>
        <input type="email" id="email" placeholder="Email" class="w-full p-2 mb-3 border dark:border-gray-600 rounded-lg dark:bg-gray-700 text-base">
        <input type="password" id="password" placeholder="Password" class="w-full p-2 mb-3 border dark:border-gray-600 rounded-lg dark:bg-gray-700 text-base">
        <button onclick="login()" class="w-full bg-primary text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition">Login</button>
    </div>
    
    <div id="logout-section" class="hidden max-w-sm mx-auto p-4 bg-white dark:bg-gray-800 rounded-lg shadow-lg mt-10 text-center">
        <p class="mb-3">Logged in as <span id="user-email" class="font-semibold"></span></p>
        <button onclick="logout()" class="bg-red-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-600 transition">Logout</button>
    </div>
    
    <!-- Main Application Section - Initially hidden -->
    <div id="app-section" class="hidden">
       <div class="container mx-auto px-4 py-8">

        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-center text-primary">Persiche Ecke POS</h1>
        </header>

        <!-- Tab Navigation -->
        <div class="flex flex-wrap mb-6 gap-2">
            <button id="tab-new-order" class="px-4 py-3 rounded-lg bg-order text-white font-semibold flex-grow"><i class="fas fa-utensils mr-2"></i>New Order</button>
            <button id="tab-kitchen" class="px-4 py-3 rounded-lg bg-kitchen text-white font-semibold flex-grow"><i class="fas fa-fire mr-2"></i>Kitchen Orders</button>
            <button id="tab-history" class="px-4 py-3 rounded-lg bg-completed text-white font-semibold flex-grow"><i class="fas fa-history mr-2"></i>Order History</button>
            <button id="tab-config" class="px-4 py-3 rounded-lg bg-config text-white font-semibold flex-grow"><i class="fas fa-cog mr-2"></i>Menu Config</button>
            <button id="tab-summary" class="px-4 py-3 rounded-lg bg-yellow-600 text-white font-semibold flex-grow"><i class="fas fa-chart-bar mr-2"></i>Sales Summary</button>
        </div>
        
        <!-- Sales Summary Tab -->
        <div id="summary-tab" class="tab-content hidden">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4 text-yellow-600">Sales Summary</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <h3 class="text-lg font-medium mb-2">Total Orders</h3>
                        <p id="total-orders-count" class="text-3xl font-bold">0</p>
                    </div>
                    
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <h3 class="text-lg font-medium mb-2">Total Revenue</h3>
                        <p id="total-revenue" class="text-3xl font-bold">$0.00</p>
                    </div>
                    
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <h3 class="text-lg font-medium mb-2">Average Order Value</h3>
                        <p id="average-order-value" class="text-3xl font-bold">$0.00</p>
                    </div>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-lg font-medium mb-4">Top Selling Items</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b dark:border-gray-700">
                                    <th class="text-left py-2">Item Name</th>
                                    <th class="text-right py-2">Quantity Sold</th>
                                    <th class="text-right py-2">Revenue</th>
                                </tr>
                            </thead>
                            <tbody id="top-items" class="divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Top items will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="no-top-items" class="text-center py-8 text-gray-500 dark:text-gray-400">
                        No sales data available
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-medium mb-4">Data Export</h3>
                    <button id="export-csv" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition">
                        <i class="fas fa-file-csv mr-2"></i> Export Sales Data (CSV)
                    </button>
                </div>
            </div>
        </div>

        <!-- New Order Tab -->
        <div id="new-order-tab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <!-- Menu Items -->
                <div class="lg:col-span-3 bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-4 text-order">Menu Items</h2>
                    
                    <div id="menu-items-container" class="overflow-y-auto max-h-[70vh] custom-scrollbar">
                        <!-- Food section -->
                        <h3 class="category-heading food-heading"><i class="fas fa-utensils mr-2"></i>Food</h3>
                        <div id="food-items" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 mb-4">
                            <!-- Food items will be dynamically inserted here -->
                        </div>
                        
                        <!-- Beverage section -->
                        <h3 class="category-heading beverage-heading"><i class="fas fa-coffee mr-2"></i>Beverages</h3>
                        <div id="beverage-items" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 mb-4">
                            <!-- Beverage items will be dynamically inserted here -->
                        </div>
                        
                        <!-- Dessert section -->
                        <h3 class="category-heading dessert-heading"><i class="fas fa-ice-cream mr-2"></i>Desserts</h3>
                        <div id="dessert-items" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                            <!-- Dessert items will be dynamically inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Current Order -->
                <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-4 text-order">Current Order</h2>
                    <div class="mb-4 max-h-[300px] overflow-y-auto custom-scrollbar">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b dark:border-gray-700">
                                    <th class="text-left py-2">Item</th>
                                    <th class="text-center py-2">Qty</th>
                                    <th class="text-right py-2">Price</th>
                                    <th class="text-right py-2">Action</th>
                                </tr>
                            </thead>
                            <tbody id="order-items">
                                <!-- Order items will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Order Summary -->
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between">
                            <span>Subtotal:</span>
                            <span id="subtotal" class="font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Discount:</span>
                            <span id="discount" class="font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between text-lg">
                            <span>Total:</span>
                            <span id="total" class="font-bold">$0.00</span>
                        </div>
                    </div>

                    <!-- Custom Discount Input -->
                    <div class="mb-4 grid grid-cols-3 gap-2">
                        <div class="col-span-1">
                            <label for="discount-percent" class="block mb-1 text-sm">Discount %:</label>
                            <input type="number" id="discount-percent" class="w-full p-2 border dark:border-gray-700 rounded-lg dark:bg-gray-700 text-base" min="0" max="100" value="10">
                        </div>
                        <div class="col-span-2">
                            <label class="block mb-1 text-sm opacity-0">Apply</label>
                            <button id="apply-discount" class="w-full bg-yellow-500 text-white py-2 rounded-lg font-semibold hover:bg-yellow-600 transition">
                                Apply Discount
                            </button>
                        </div>
                    </div>

                    <!-- Payment Section -->
                    <div class="mb-4">
                        <label for="amount-received" class="block mb-2">Amount Received:</label>
                        <input type="number" id="amount-received" class="w-full p-2 border dark:border-gray-700 rounded-lg dark:bg-gray-700 text-base" min="0" step="0.01">
                    </div>
                    
                    <div class="mb-6">
                        <label for="change" class="block mb-2">Change to Return:</label>
                        <input type="text" id="change" class="w-full p-2 border dark:border-gray-700 rounded-lg dark:bg-gray-700 bg-gray-100 dark:bg-gray-800" readonly>
                    </div>

                    <!-- Order Actions -->
                    <div class="grid grid-cols-2 gap-4">
                        <button id="clear-order" class="bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition">
                            Clear Order
                        </button>
                        <button id="confirm-order" class="bg-order text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                            Confirm Order
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Kitchen Orders Tab -->
        <div id="kitchen-tab" class="tab-content hidden">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4 text-kitchen">Kitchen Orders</h2>
                <div id="kitchen-orders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Kitchen orders will be dynamically inserted here -->
                </div>
                <div id="no-kitchen-orders" class="text-center py-8 text-gray-500 dark:text-gray-400">
                    No pending orders
                </div>
            </div>
        </div>

        <!-- Order History Tab -->
        <div id="history-tab" class="tab-content hidden">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4 text-completed">Order History</h2>
                <div class="space-y-2 mb-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-medium">Completed Orders</h3>
                        <div class="flex items-center">
                            <span class="mr-2">Total Sales:</span>
                            <span id="history-total-sales" class="font-bold text-lg">$0.00</span>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b dark:border-gray-700">
                                <th class="text-left py-2">Order ID</th>
                                <th class="text-left py-2">Date &amp; Time</th>
                                <th class="text-left py-2">Items</th>
                                <th class="text-right py-2">Total</th>
                                <th class="text-right py-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="history-items" class="divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- History items will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
                <div id="no-history" class="text-center py-8 text-gray-500 dark:text-gray-400">
                    No order history yet
                </div>
            </div>
        </div>

        <!-- Menu Configuration Tab -->
        <div id="config-tab" class="tab-content hidden">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4 text-config">Menu Configuration</h2>
                
                <!-- Add Menu Item Form -->
                <div class="mb-8 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                    <h3 class="text-lg font-medium mb-4">Add New Menu Item</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div class="md:col-span-2">
                            <label for="item-name" class="block mb-2">Item Name:</label>
                            <input type="text" id="item-name" class="w-full p-2 border dark:border-gray-600 rounded-lg dark:bg-gray-800 text-base" placeholder="e.g. Cheeseburger">
                        </div>
                        <div>
                            <label for="item-price" class="block mb-2">Price ($):</label>
                            <input type="number" id="item-price" class="w-full p-2 border dark:border-gray-600 rounded-lg dark:bg-gray-800 text-base" min="0" step="0.01" placeholder="9.99">
                        </div>
                        <div>
                            <label for="item-category" class="block mb-2">Category:</label>
                            <select id="item-category" class="w-full p-2 border dark:border-gray-600 rounded-lg dark:bg-gray-800 text-base">
                                <option value="food">Food</option>
                                <option value="beverage">Beverage</option>
                                <option value="dessert">Dessert</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="add-item" class="w-full bg-config text-white py-2 rounded-lg font-semibold hover:bg-purple-700 transition">
                                Add Item
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Menu Items List -->
                <h3 class="text-lg font-medium mb-4">Current Menu Items</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b dark:border-gray-700">
                                <th class="text-left py-2">Item Name</th>
                                <th class="text-left py-2">Category</th>
                                <th class="text-right py-2">Price</th>
                                <th class="text-right py-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="menu-config-items" class="divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Menu config items will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
                <div id="no-menu-items" class="text-center py-8 text-gray-500 dark:text-gray-400">
                    No menu items yet. Add some items above!
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Edit Menu Item Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Edit Menu Item</h3>
            <input type="hidden" id="edit-item-id">
            <div class="mb-4">
                <label for="edit-item-name" class="block mb-2">Item Name:</label>
                <input type="text" id="edit-item-name" class="w-full p-2 border dark:border-gray-700 rounded-lg dark:bg-gray-700 text-base">
            </div>
            <div class="mb-4">
                <label for="edit-item-price" class="block mb-2">Price ($):</label>
                <input type="number" id="edit-item-price" class="w-full p-2 border dark:border-gray-700 rounded-lg dark:bg-gray-700 text-base" min="0" step="0.01">
            </div>
            <div class="mb-4">
                <label for="edit-item-category" class="block mb-2">Category:</label>
                <select id="edit-item-category" class="w-full p-2 border dark:border-gray-700 rounded-lg dark:bg-gray-700 text-base">
                    <option value="food">Food</option>
                    <option value="beverage">Beverage</option>
                    <option value="dessert">Dessert</option>
                </select>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-edit" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                    Cancel
                </button>
                <button id="save-edit" class="px-4 py-2 bg-config text-white rounded-lg hover:bg-purple-700 transition">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
    
    <!-- Edit Order Modal -->
    <div id="edit-order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg w-full max-w-lg">
            <h3 class="text-lg font-semibold mb-4">Edit Order</h3>
            <input type="hidden" id="edit-order-id">
            <input type="hidden" id="edit-order-type">
            
            <div class="mb-4 max-h-[400px] overflow-y-auto custom-scrollbar">
                <table class="w-full">
                    <thead>
                        <tr class="border-b dark:border-gray-700">
                            <th class="text-left py-2">Item</th>
                            <th class="text-center py-2">Qty</th>
                            <th class="text-right py-2">Price</th>
                            <th class="text-right py-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="edit-order-items">
                        <!-- Order items for editing will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
            
            <div class="space-y-2 mb-4">
                <div class="flex justify-between">
                    <span>Subtotal:</span>
                    <span id="edit-subtotal" class="font-semibold">$0.00</span>
                </div>
                <div class="grid grid-cols-3 gap-2 items-center">
                    <div class="col-span-1">
                        <label for="edit-discount-percent" class="text-sm">Discount %:</label>
                        <input type="number" id="edit-discount-percent" class="w-full p-2 border dark:border-gray-700 rounded-lg dark:bg-gray-700 text-base" min="0" max="100" value="0">
                    </div>
                    <div class="col-span-1 text-right">
                        <span>Discount:</span>
                    </div>
                    <div class="col-span-1 text-right">
                        <span id="edit-discount" class="font-semibold">$0.00</span>
                    </div>
                </div>
                <div class="flex justify-between text-lg">
                    <span>Total:</span>
                    <span id="edit-total" class="font-bold">$0.00</span>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button id="cancel-edit-order" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                    Cancel
                </button>
                <button id="save-edit-order" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize dark mode based on system preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Firebase configuration - FIXED proper initialization
        const firebaseConfig = {
          apiKey: "AIzaSyAjEtQ_YZcltxOm_4Tbe-NgFOtVBw6u_zQ",
          authDomain: "persianecke.firebaseapp.com",
          projectId: "persianecke",
          storageBucket: "persianecke.firebasestorage.app",
          messagingSenderId: "241462886109",
          appId: "1:241462886109:web:9865fcbfc61a95996d2534"
        };

        // Initialize Firebase - Fixed syntax errors and offline detection
        let db = null;
        let firebaseInitialized = false;
        
        function initializeFirebase() {
            try {
                // Check if already initialized to avoid duplicate app errors
                if (!firebaseInitialized) {
                    firebase.initializeApp(firebaseConfig);
                    
                    db = firebase.firestore();
                    firebaseInitialized = true;
                    console.log("Firebase initialized successfully");
                    return true;
                } else {
                    db = firebase.firestore();
                    return true;
                }
            } catch (error) {
                console.error("Firebase initialization error:", error);
                return false;
            }
        }
        
        // First attempt to initialize
        initializeFirebase();

        // Data Models
        const POS = {
            menuItems: [],
            currentOrder: {
                items: [],
                subtotal: 0,
                discount: 0,
                total: 0,
                discountApplied: false,
                discountPercent: 10 // Default discount percentage
            },
            kitchenOrders: [],
            orderHistory: [],
            orderCounter: 1000, // Starting order number
            isOnline: false,
            reconnectAttempts: 0,
            maxReconnectAttempts: 3,
            
            // Fix the updateConnectionStatus function - FIXED nested duplication issue
            updateConnectionStatus(online, error) {
                this.isOnline = online;
                const statusEl = document.getElementById('connection-status');
                const statusTextEl = document.getElementById('status-text');
                const currentUser = firebase.auth().currentUser;
            
                if (online) {
                    if (currentUser) {
                        statusTextEl.textContent = '✅ Online - Logged in as ' + currentUser.email;
                        statusEl.classList.remove('status-offline');
                        statusEl.classList.add('status-online');
                    } else {
                        statusTextEl.textContent = '⚠️ Online - Not Logged In';
                        statusEl.classList.remove('status-online');
                        statusEl.classList.add('status-offline');
                    }
                } else {
                    if (error) {
                        statusTextEl.textContent = `Offline: ${error.message || 'Connection failed'}`;
                    } else {
                        statusTextEl.textContent = 'Offline Mode';
                    }
                    statusEl.classList.remove('status-online');
                    statusEl.classList.add('status-offline');
                }
            },
            
            // Try to reconnect to Firebase
            attemptReconnect() {
                if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                    console.log("Max reconnect attempts reached. Working in offline mode.");
                    return;
                }
                
                this.reconnectAttempts++;
                
                const statusTextEl = document.getElementById('status-text');
                statusTextEl.textContent = `Trying to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`;
                
                // Try to initialize Firebase again
                if (initializeFirebase()) {
                    this.updateConnectionStatus(true);
                    // Set up listeners again
                    this.setupFirebaseListeners();
                    // Try to sync local data
                    this.syncDataToFirebase();
                } else {
                    this.updateConnectionStatus(false, new Error("Reconnection failed"));
                }
            },
            
            // Sync all local data to Firebase when connection is restored
            syncDataToFirebase() {
                if (!db || !this.isOnline) return;
                
                try {
                    // Save menu items
                    this.saveMenuItems();
                    
                    // Save kitchen orders
                    this.saveKitchenOrders();
                    
                    // Save order history
                    this.saveOrderHistory();
                    
                    // Save order counter
                    this.saveOrderCounter();
                    
                    console.log("All data synced to Firebase");
                } catch (error) {
                    console.error("Error syncing data to Firebase:", error);
                    this.updateConnectionStatus(false, error);
                }
            },
            
            // Generate a unique order ID
            generateOrderId() {
                this.orderCounter++;
                localStorage.setItem('pos_orderCounter', this.orderCounter);
                this.saveOrderCounter();
                return 'PE-' + this.orderCounter;
            },
            
            // Initialize the app
            init() {
                // Check network status
                this.updateConnectionStatus(navigator.onLine);
                
                // Load initial data
                this.loadOrderCounter();
                this.loadMenuItems();
                this.loadKitchenOrders();
                this.loadOrderHistory();
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Setup Firebase retry button
                document.getElementById('retry-connection').addEventListener('click', () => {
                    this.attemptReconnect();
                });
                
                // Setup Firebase listeners if we have Firebase initialized
                if (db) {
                    this.setupFirebaseListeners();
                }
            },
            
            // Setup Firebase real-time listeners with improved error handling
            setupFirebaseListeners() {
                // Only setup listeners if Firebase is available
                if (!db) return;
                
                try {
                    // Listen for menu items changes with error handling
                    const menuItemsUnsubscribe = db.collection('config').doc('menuItems').onSnapshot(doc => {
                        if (doc.exists && doc.data().items) {
                            this.menuItems = doc.data().items;
                            localStorage.setItem('pos_menuItems', JSON.stringify(this.menuItems));
                            this.renderMenuItems();
                            this.renderMenuConfigItems();
                            this.updateConnectionStatus(true);
                        }
                    }, error => {
                        console.error("Menu items listener error:", error);
                        this.updateConnectionStatus(false, error);
                    });
                    
                    // Listen for kitchen orders changes with error handling
                    const kitchenOrdersUnsubscribe = db.collection('kitchenOrders').onSnapshot(snapshot => {
                        this.kitchenOrders = [];
                        snapshot.forEach(doc => {
                            this.kitchenOrders.push(doc.data());
                        });
                        localStorage.setItem('pos_kitchenOrders', JSON.stringify(this.kitchenOrders));
                        this.renderKitchenOrders();
                        this.updateConnectionStatus(true);
                    }, error => {
                        console.error("Kitchen orders listener error:", error);
                        this.updateConnectionStatus(false, error);
                    });
                    
                    // Listen for order history changes with error handling
                    const orderHistoryUnsubscribe = db.collection('orderHistory').onSnapshot(snapshot => {
                        this.orderHistory = [];
                        snapshot.forEach(doc => {
                            this.orderHistory.push(doc.data());
                        });
                        localStorage.setItem('pos_orderHistory', JSON.stringify(this.orderHistory));
                        this.renderOrderHistory();
                        this.updateSalesStats();
                        this.updateHistoryTotalSales();
                        this.updateConnectionStatus(true);
                    }, error => {
                        console.error("Order history listener error:", error);
                        this.updateConnectionStatus(false, error);
                    });
                    
                    // Listen for order counter changes with error handling
                    const orderCounterUnsubscribe = db.collection('config').doc('orderCounter').onSnapshot(doc => {
                        if (doc.exists && doc.data().counter) {
                            this.orderCounter = doc.data().counter;
                            localStorage.setItem('pos_orderCounter', this.orderCounter);
                        }
                    }, error => {
                        console.error("Order counter listener error:", error);
                        this.updateConnectionStatus(false, error);
                    });
                    
                    // Store unsubscribe functions for cleanup if needed
                    this.firebaseUnsubscribes = {
                        menuItems: menuItemsUnsubscribe,
                        kitchenOrders: kitchenOrdersUnsubscribe,
                        orderHistory: orderHistoryUnsubscribe,
                        orderCounter: orderCounterUnsubscribe
                    };
                    
                    this.updateConnectionStatus(true);
                } catch (error) {
                    console.error("Error setting up Firebase listeners:", error);
                    this.updateConnectionStatus(false, error);
                }
            },
            
            // Clean up Firebase listeners
            cleanupFirebaseListeners() {
                if (this.firebaseUnsubscribes) {
                    Object.values(this.firebaseUnsubscribes).forEach(unsubscribe => {
                        if (typeof unsubscribe === 'function') {
                            unsubscribe();
                        }
                    });
                }
            },
            
            // Save order counter to Firebase (if available) and localStorage with better error handling
            saveOrderCounter() {
                localStorage.setItem('pos_orderCounter', this.orderCounter);
                
                if (db && this.isOnline) {
                    db.collection('config').doc('orderCounter').set({
                        counter: this.orderCounter,
                        updatedAt: new Date().toISOString()
                    }).catch(error => {
                        console.error("Error saving order counter to Firebase:", error);
                        this.updateConnectionStatus(false, error);
                    });
                }
            },
            
            // Load order counter from Firebase or localStorage with better error handling
            loadOrderCounter() {
                // First load from localStorage
                const counter = localStorage.getItem('pos_orderCounter');
                if (counter) {
                    this.orderCounter = parseInt(counter);
                }
                
                // If Firebase is available, try to fetch from there
                if (db && this.isOnline) {
                    db.collection('config').doc('orderCounter').get()
                        .then(doc => {
                            if (doc.exists && doc.data().counter) {
                                this.orderCounter = doc.data().counter;
                                localStorage.setItem('pos_orderCounter', this.orderCounter);
                            } else if (counter) {
                                // If no counter in Firebase but we have one locally, save it
                                this.saveOrderCounter();
                            }
                        })
                        .catch(error => {
                            console.error("Error loading order counter from Firebase:", error);
                            this.updateConnectionStatus(false, error);
                        });
                }
            },
            
            // Load menu items from Firebase or localStorage with better error handling
            loadMenuItems() {
                // First load from localStorage for immediate display
                const stored = localStorage.getItem('pos_menuItems');
                if (stored) {
                    try {
                        this.menuItems = JSON.parse(stored);
                        this.renderMenuItems();
                        this.renderMenuConfigItems();
                    } catch (e) {
                        console.error("Error parsing stored menu items:", e);
                        this.resetMenuItems();
                    }
                } else {
                    this.resetMenuItems();
                }
                
                // If online and db available, save to Firebase to sync with other devices
                this.saveMenuItems();
            },
            
            // Reset menu items to defaults
            resetMenuItems() {
                // Default menu items
                this.menuItems = [
                    { id: '1', name: 'Cheeseburger', price: 8.99, category: 'food' },
                    { id: '2', name: 'Pizza', price: 12.99, category: 'food' },
                    { id: '3', name: 'Salad', price: 6.99, category: 'food' },
                    { id: '4', name: 'Fries', price: 3.99, category: 'food' },
                    { id: '5', name: 'Soda', price: 1.99, category: 'beverage' },
                    { id: '6', name: 'Coffee', price: 2.99, category: 'beverage' },
                    { id: '7', name: 'Ice Cream', price: 4.99, category: 'dessert' },
                    { id: '8', name: 'Cake', price: 5.99, category: 'dessert' }
                ];
                localStorage.setItem('pos_menuItems', JSON.stringify(this.menuItems));
                this.renderMenuItems();
                this.renderMenuConfigItems();
            },
            
            // Load kitchen orders from localStorage with error handling
            loadKitchenOrders() {
                const stored = localStorage.getItem('pos_kitchenOrders');
                if (stored) {
                    try {
                        this.kitchenOrders = JSON.parse(stored);
                        this.renderKitchenOrders();
                    } catch (e) {
                        console.error("Error parsing stored kitchen orders:", e);
                        this.kitchenOrders = [];
                        this.renderKitchenOrders();
                    }
                } else {
                    this.kitchenOrders = [];
                    this.renderKitchenOrders();
                }
            },
            
            // Load order history from localStorage with error handling
            loadOrderHistory() {
                const stored = localStorage.getItem('pos_orderHistory');
                if (stored) {
                    try {
                        this.orderHistory = JSON.parse(stored);
                        this.renderOrderHistory();
                        this.updateSalesStats();
                        this.updateHistoryTotalSales();
                    } catch (e) {
                        console.error("Error parsing stored order history:", e);
                        this.orderHistory = [];
                        this.renderOrderHistory();
                        this.updateSalesStats();
                        this.updateHistoryTotalSales();
                    }
                } else {
                    this.orderHistory = [];
                    this.renderOrderHistory();
                    this.updateSalesStats();
                    this.updateHistoryTotalSales();
                }
            },
            
            // Save menu items to Firebase and localStorage with better error handling
            saveMenuItems() {
                localStorage.setItem('pos_menuItems', JSON.stringify(this.menuItems));
                
                if (db && this.isOnline) {
                    db.collection('config').doc('menuItems').set({
                        items: this.menuItems,
                        updatedAt: new Date().toISOString()
                    }).then(() => {
                        console.log("Menu items saved to Firebase");
                    }).catch(error => {
                        console.error("Error saving menu items to Firebase:", error);
                        this.updateConnectionStatus(false, error);
                    });
                }
            },
            
            // Save kitchen orders to Firebase and localStorage with better error handling
            saveKitchenOrders() {
                localStorage.setItem('pos_kitchenOrders', JSON.stringify(this.kitchenOrders));
                
                if (db && this.isOnline) {
                    try {
                        // Use a more robust approach for batch operations
                        const syncKitchenOrders = async () => {
                            // Create a new batch
                            const batch = db.batch();
                            
                            // Get existing docs
                            const snapshot = await db.collection('kitchenOrders').get();
                            
                            // Delete all existing docs in batch
                            snapshot.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            
                            // Add all current kitchen orders in batch
                            this.kitchenOrders.forEach(order => {
                                const docRef = db.collection('kitchenOrders').doc(order.id);
                                batch.set(docRef, {
                                    ...order,
                                    updatedAt: new Date().toISOString()
                                });
                            });
                            
                            // Commit the batch
                            await batch.commit();
                            console.log("Kitchen orders synced to Firebase");
                        };
                        
                        // Run the sync operation
                        syncKitchenOrders().catch(error => {
                            console.error("Error syncing kitchen orders to Firebase:", error);
                            this.updateConnectionStatus(false, error);
                        });
                    } catch (error) {
                        console.error("Error in kitchen orders sync operation:", error);
                        this.updateConnectionStatus(false, error);
                    }
                }
                
                this.exportDataToCSV();
            },
            
            // Save order history to Firebase and localStorage with better error handling
            saveOrderHistory() {
                localStorage.setItem('pos_orderHistory', JSON.stringify(this.orderHistory));
                
                if (db && this.isOnline) {
                    try {
                        // Use a more robust approach for batch operations
                        const syncOrderHistory = async () => {
                            // Create a new batch
                            const batch = db.batch();
                            
                            // Get existing docs
                            const snapshot = await db.collection('orderHistory').get();
                            
                            // Delete all existing docs in batch
                            snapshot.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            
                            // Add all current history in batch
                            this.orderHistory.forEach(order => {
                                const docRef = db.collection('orderHistory').doc(order.id);
                                batch.set(docRef, {
                                    ...order,
                                    updatedAt: new Date().toISOString()
                                });
                            });
                            
                            // Commit the batch
                            await batch.commit();
                            console.log("Order history synced to Firebase");
                        };
                        
                        // Run the sync operation
                        syncOrderHistory().catch(error => {
                            console.error("Error syncing order history to Firebase:", error);
                            this.updateConnectionStatus(false, error);
                        });
                    } catch (error) {
                        console.error("Error in order history sync operation:", error);
                        this.updateConnectionStatus(false, error);
                    }
                }
                
                this.exportDataToCSV();
                this.updateSalesStats();
                this.updateHistoryTotalSales();
            },
            
            // Menu item operations
            addMenuItem(name, price, category) {
                const id = Date.now().toString();
                this.menuItems.push({ id, name, price: parseFloat(price), category });
                this.saveMenuItems();
            },
            
            updateMenuItem(id, name, price, category) {
                const index = this.menuItems.findIndex(item => item.id === id);
                if (index !== -1) {
                    this.menuItems[index] = { id, name, price: parseFloat(price), category };
                    this.saveMenuItems();
                }
            },
            
            deleteMenuItem(id) {
                this.menuItems = this.menuItems.filter(item => item.id !== id);
                this.saveMenuItems();
            },
            
            // Order operations
            addItemToOrder(id) {
                const menuItem = this.menuItems.find(item => item.id === id);
                if (!menuItem) return;
                
                const existingItem = this.currentOrder.items.find(item => item.id === id);
                
                if (existingItem) {
                    existingItem.quantity += 1;
                    existingItem.total = existingItem.quantity * existingItem.price;
                } else {
                    this.currentOrder.items.push({
                        id: menuItem.id,
                        name: menuItem.name,
                        price: menuItem.price,
                        category: menuItem.category,
                        quantity: 1,
                        total: menuItem.price
                    });
                }
                
                this.updateOrderTotals();
                this.renderOrderItems();
            },
            
            removeItemFromOrder(id) {
                const index = this.currentOrder.items.findIndex(item => item.id === id);
                if (index !== -1) {
                    if (this.currentOrder.items[index].quantity > 1) {
                        this.currentOrder.items[index].quantity -= 1;
                        this.currentOrder.items[index].total = this.currentOrder.items[index].quantity * this.currentOrder.items[index].price;
                    } else {
                        this.currentOrder.items.splice(index, 1);
                    }
                    this.updateOrderTotals();
                    this.renderOrderItems();
                }
            },
            
            updateOrderTotals() {
                // Calculate subtotal
                this.currentOrder.subtotal = this.currentOrder.items.reduce((sum, item) => sum + item.total, 0);
                
                // Apply discount if it was previously applied
                if (this.currentOrder.discountApplied) {
                    this.currentOrder.discount = this.currentOrder.subtotal * (this.currentOrder.discountPercent / 100);
                }
                
                // Calculate total
                this.currentOrder.total = this.currentOrder.subtotal - this.currentOrder.discount;
                
                // Update DOM
                document.getElementById('subtotal').textContent = '$' + this.currentOrder.subtotal.toFixed(2);
                document.getElementById('discount').textContent = '$' + this.currentOrder.discount.toFixed(2);
                document.getElementById('total').textContent = '$' + this.currentOrder.total.toFixed(2);
                
                // Clear amount received and change fields
                document.getElementById('amount-received').value = '';
                document.getElementById('change').value = '';
            },
            
            applyDiscount() {
                if (this.currentOrder.items.length > 0) {
                    // Get the discount percentage from the input
                    const discountPercent = parseFloat(document.getElementById('discount-percent').value);
                    if (!isNaN(discountPercent) && discountPercent >= 0 && discountPercent <= 100) {
                        this.currentOrder.discountApplied = true;
                        this.currentOrder.discountPercent = discountPercent;
                        this.currentOrder.discount = this.currentOrder.subtotal * (discountPercent / 100);
                        this.updateOrderTotals();
                    } else {
                        const statusEl = document.getElementById('connection-status');
                        const statusTextEl = document.getElementById('status-text');
                        statusTextEl.textContent = 'Please enter a valid discount percentage (0-100)';
                        statusEl.classList.remove('status-online');
                        statusEl.classList.add('status-offline');
                        
                        // Reset after 3 seconds
                        setTimeout(() => {
                            this.updateConnectionStatus(this.isOnline);
                        }, 3000);
                    }
                }
            },
            
            calculateChange(amountReceived) {
                if (amountReceived >= this.currentOrder.total) {
                    const change = amountReceived - this.currentOrder.total;
                    document.getElementById('change').value = '$' + change.toFixed(2);
                } else {
                    document.getElementById('change').value = 'Insufficient amount';
                }
            },
            
            clearOrder() {
                this.currentOrder = {
                    items: [],
                    subtotal: 0,
                    discount: 0,
                    total: 0,
                    discountApplied: false,
                    discountPercent: 10
                };
                
                this.renderOrderItems();
                this.updateOrderTotals();
                
                document.getElementById('amount-received').value = '';
                document.getElementById('change').value = '';
                document.getElementById('discount-percent').value = '10';
            },
            
            confirmOrder() {
                if (this.currentOrder.items.length === 0) {
                    const statusEl = document.getElementById('connection-status');
                    const statusTextEl = document.getElementById('status-text');
                    statusTextEl.textContent = 'Cannot confirm an empty order';
                    statusEl.classList.remove('status-online');
                    statusEl.classList.add('status-offline');
                    
                    // Reset after 3 seconds
                    setTimeout(() => {
                        this.updateConnectionStatus(this.isOnline);
                    }, 3000);
                    return;
                }
                
                const newOrder = {
                    id: this.generateOrderId(),
                    items: [...this.currentOrder.items],
                    subtotal: this.currentOrder.subtotal,
                    discount: this.currentOrder.discount,
                    discountPercent: this.currentOrder.discountPercent,
                    total: this.currentOrder.total,
                    timestamp: new Date().toISOString(),
                    createdAt: new Date().getTime()
                };
                
                this.kitchenOrders.push(newOrder);
                this.saveKitchenOrders();
                
                this.clearOrder();
            },
            
            completeOrder(id) {
                const index = this.kitchenOrders.findIndex(order => order.id === id);
                if (index !== -1) {
                    const completedOrder = {
                        ...this.kitchenOrders[index],
                        completedAt: new Date().getTime()
                    };
                    
                    this.orderHistory.unshift(completedOrder);
                    this.kitchenOrders.splice(index, 1);
                    
                    this.saveKitchenOrders();
                    this.saveOrderHistory();
                }
            },
            
            editKitchenOrder(id) {
                const orderIndex = this.kitchenOrders.findIndex(order => order.id === id);
                if (orderIndex !== -1) {
                    const order = this.kitchenOrders[orderIndex];
                    this.openEditOrderModal(order, 'kitchen');
                }
            },
            
            editHistoryOrder(id) {
                const orderIndex = this.orderHistory.findIndex(order => order.id === id);
                if (orderIndex !== -1) {
                    const order = this.orderHistory[orderIndex];
                    this.openEditOrderModal(order, 'history');
                }
            },
            
            openEditOrderModal(order, type) {
                document.getElementById('edit-order-id').value = order.id;
                document.getElementById('edit-order-type').value = type;
                
                const itemsContainer = document.getElementById('edit-order-items');
                itemsContainer.innerHTML = '';
                
                // Fill items into the modal
                order.items.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b dark:border-gray-700';
                    row.innerHTML = `
                        <td class="py-2">${item.name}</td>
                        <td class="py-2 text-center">
                            <div class="flex items-center justify-center">
                                <button class="edit-qty-minus bg-gray-200 dark:bg-gray-700 px-2 rounded-l" data-id="${item.id}">-</button>
                                <span class="px-2">${item.quantity}</span>
                                <button class="edit-qty-plus bg-gray-200 dark:bg-gray-700 px-2 rounded-r" data-id="${item.id}">+</button>
                            </div>
                        </td>
                        <td class="py-2 text-right">$${item.total.toFixed(2)}</td>
                        <td class="py-2 text-right">
                            <button class="edit-remove-item text-red-500 hover:text-red-700" data-id="${item.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    itemsContainer.appendChild(row);
                });
                
                // Set discount
                document.getElementById('edit-discount-percent').value = order.discountPercent || 0;
                
                // Set totals
                document.getElementById('edit-subtotal').textContent = '$' + order.subtotal.toFixed(2);
                document.getElementById('edit-discount').textContent = '$' + order.discount.toFixed(2);
                document.getElementById('edit-total').textContent = '$' + order.total.toFixed(2);
                
                // Show modal
                document.getElementById('edit-order-modal').classList.remove('hidden');
            },
            
            handleEditOrderQtyChange(itemId, change) {
                const orderId = document.getElementById('edit-order-id').value;
                const orderType = document.getElementById('edit-order-type').value;
                
                // Find the order
                let orders = orderType === 'kitchen' ? this.kitchenOrders : this.orderHistory;
                const orderIndex = orders.findIndex(order => order.id === orderId);
                
                if (orderIndex !== -1) {
                    // Find the item
                    const itemIndex = orders[orderIndex].items.findIndex(item => item.id === itemId);
                    
                    if (itemIndex !== -1) {
                        const item = orders[orderIndex].items[itemIndex];
                        
                        // Update quantity
                        if (change === 'add') {
                            item.quantity += 1;
                        } else if (change === 'subtract' && item.quantity > 1) {
                            item.quantity -= 1;
                        } else if (change === 'remove') {
                            orders[orderIndex].items.splice(itemIndex, 1);
                        }
                        
                        // Update item total
                        if (change !== 'remove') {
                            item.total = item.quantity * item.price;
                        }
                        
                        // Recalculate order totals
                        this.recalculateOrderTotals(orders[orderIndex]);
                        
                        // Update edit modal display
                        this.updateEditOrderModal(orders[orderIndex]);
                    }
                }
            },
            
            recalculateOrderTotals(order) {
                // Calculate subtotal
                order.subtotal = order.items.reduce((sum, item) => sum + item.total, 0);
                
                // Apply discount
                if (order.discountPercent) {
                    order.discount = order.subtotal * (order.discountPercent / 100);
                } else {
                    order.discount = 0;
                }
                
                // Calculate total
                order.total = order.subtotal - order.discount;
            },
            
            updateEditOrderModal(order) {
                // Update items in the modal
                const itemsContainer = document.getElementById('edit-order-items');
                itemsContainer.innerHTML = '';
                
                order.items.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b dark:border-gray-700';
                    row.innerHTML = `
                        <td class="py-2">${item.name}</td>
                        <td class="py-2 text-center">
                            <div class="flex items-center justify-center">
                                <button class="edit-qty-minus bg-gray-200 dark:bg-gray-700 px-2 rounded-l" data-id="${item.id}">-</button>
                                <span class="px-2">${item.quantity}</span>
                                <button class="edit-qty-plus bg-gray-200 dark:bg-gray-700 px-2 rounded-r" data-id="${item.id}">+</button>
                            </div>
                        </td>
                        <td class="py-2 text-right">$${item.total.toFixed(2)}</td>
                        <td class="py-2 text-right">
                            <button class="edit-remove-item text-red-500 hover:text-red-700" data-id="${item.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    itemsContainer.appendChild(row);
                });
                
                // Update totals
                document.getElementById('edit-subtotal').textContent = '$' + order.subtotal.toFixed(2);
                document.getElementById('edit-discount').textContent = '$' + order.discount.toFixed(2);
                document.getElementById('edit-total').textContent = '$' + order.total.toFixed(2);
            },
            
            saveEditedOrder() {
                const orderId = document.getElementById('edit-order-id').value;
                const orderType = document.getElementById('edit-order-type').value;
                const discountPercent = parseFloat(document.getElementById('edit-discount-percent').value);
                
                // Find the order
                let orders = orderType === 'kitchen' ? this.kitchenOrders : this.orderHistory;
                const orderIndex = orders.findIndex(order => order.id === orderId);
                
                if (orderIndex !== -1) {
                    // Update discount
                    if (!isNaN(discountPercent) && discountPercent >= 0 && discountPercent <= 100) {
                        orders[orderIndex].discountPercent = discountPercent;
                        orders[orderIndex].discount = orders[orderIndex].subtotal * (discountPercent / 100);
                        orders[orderIndex].total = orders[orderIndex].subtotal - orders[orderIndex].discount;
                    }
                    
                    // Save changes
                    if (orderType === 'kitchen') {
                        this.saveKitchenOrders();
                    } else {
                        this.saveOrderHistory();
                    }
                    
                    // Close modal
                    document.getElementById('edit-order-modal').classList.add('hidden');
                }
            },
            
            // Sales statistics
            updateSalesStats() {
                if (this.orderHistory.length === 0) {
                    document.getElementById('total-orders-count').textContent = '0';
                    document.getElementById('total-revenue').textContent = '$0.00';
                    document.getElementById('average-order-value').textContent = '$0.00';
                    document.getElementById('no-top-items').classList.remove('hidden');
                    document.getElementById('top-items').innerHTML = '';
                    return;
                }
                
                // Total orders
                document.getElementById('total-orders-count').textContent = this.orderHistory.length;
                
                // Total revenue
                const totalRevenue = this.orderHistory.reduce((sum, order) => sum + order.total, 0);
                document.getElementById('total-revenue').textContent = '$' + totalRevenue.toFixed(2);
                
                // Average order value
                const avgOrderValue = totalRevenue / this.orderHistory.length;
                document.getElementById('average-order-value').textContent = '$' + avgOrderValue.toFixed(2);
                
                // Top selling items
                const itemSales = {};
                
                // Count item occurrences and calculate revenue
                this.orderHistory.forEach(order => {
                    order.items.forEach(item => {
                        if (!itemSales[item.name]) {
                            itemSales[item.name] = {
                                quantity: 0,
                                revenue: 0
                            };
                        }
                        
                        itemSales[item.name].quantity += item.quantity;
                        itemSales[item.name].revenue += item.total;
                    });
                });
                
                // Convert to array and sort by quantity
                const sortedItems = Object.entries(itemSales)
                    .map(([name, stats]) => ({
                        name,
                        quantity: stats.quantity,
                        revenue: stats.revenue
                    }))
                    .sort((a, b) => b.quantity - a.quantity);
                
                // Display top items
                const topItemsContainer = document.getElementById('top-items');
                topItemsContainer.innerHTML = '';
                
                if (sortedItems.length === 0) {
                    document.getElementById('no-top-items').classList.remove('hidden');
                } else {
                    document.getElementById('no-top-items').classList.add('hidden');
                    
                    // Display top 10 items
                    sortedItems.slice(0, 10).forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="py-2">${item.name}</td>
                            <td class="py-2 text-right">${item.quantity}</td>
                            <td class="py-2 text-right">$${item.revenue.toFixed(2)}</td>
                        `;
                        topItemsContainer.appendChild(row);
                    });
                }
            },
            
            updateHistoryTotalSales() {
                if (this.orderHistory.length === 0) {
                    document.getElementById('history-total-sales').textContent = '$0.00';
                    return;
                }
                
                const totalSales = this.orderHistory.reduce((sum, order) => sum + order.total, 0);
                document.getElementById('history-total-sales').textContent = '$' + totalSales.toFixed(2);
            },
            
            // CSV Export
            exportDataToCSV() {
                // Create CSV content for kitchen orders
                let kitchenOrdersCSV = 'Order ID,Date,Time,Items,Subtotal,Discount,Total\n';
                
                this.kitchenOrders.forEach(order => {
                    const date = new Date(order.timestamp);
                    const dateFormatted = date.toLocaleDateString();
                    const timeFormatted = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    const itemsList = order.items.map(item => 
                        `${item.quantity}x ${item.name}`
                    ).join('; ');
                    
                    kitchenOrdersCSV += `${order.id},${dateFormatted},${timeFormatted},"${itemsList}",${order.subtotal.toFixed(2)},${order.discount.toFixed(2)},${order.total.toFixed(2)}\n`;
                });
                
                // Create CSV content for order history
                let historyCSV = 'Order ID,Date,Time,Items,Subtotal,Discount,Total\n';
                
                this.orderHistory.forEach(order => {
                    const date = new Date(order.timestamp);
                    const dateFormatted = date.toLocaleDateString();
                    const timeFormatted = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    const itemsList = order.items.map(item => 
                        `${item.quantity}x ${item.name}`
                    ).join('; ');
                    
                    historyCSV += `${order.id},${dateFormatted},${timeFormatted},"${itemsList}",${order.subtotal.toFixed(2)},${order.discount.toFixed(2)},${order.total.toFixed(2)}\n`;
                });
                
                // Store in localStorage
                localStorage.setItem('pos_kitchen_orders_csv', kitchenOrdersCSV);
                localStorage.setItem('pos_order_history_csv', historyCSV);
            },
            
            downloadCSV() {
                // Combine both CSV data
                const kitchenCSV = localStorage.getItem('pos_kitchen_orders_csv') || '';
                const historyCSV = localStorage.getItem('pos_order_history_csv') || '';
                
                const combinedCSV = 
                    "KITCHEN ORDERS\n" + 
                    kitchenCSV + 
                    "\n\nORDER HISTORY\n" + 
                    historyCSV;
                
                // Create blob
                const blob = new Blob([combinedCSV], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                // Create link and trigger download
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', 'persiche_ecke_sales_' + new Date().toISOString().slice(0, 10) + '.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },
            
            // UI Rendering
            renderMenuItems() {
                // Clear all containers
                document.getElementById('food-items').innerHTML = '';
                document.getElementById('beverage-items').innerHTML = '';
                document.getElementById('dessert-items').innerHTML = '';
                
                // Group items by category
                const foodItems = this.menuItems.filter(item => item.category === 'food');
                const beverageItems = this.menuItems.filter(item => item.category === 'beverage');
                const dessertItems = this.menuItems.filter(item => item.category === 'dessert');
                
                // Render each category
                this.renderCategoryItems(foodItems, 'food-items', 'food', 'utensils');
                this.renderCategoryItems(beverageItems, 'beverage-items', 'beverage', 'coffee');
                this.renderCategoryItems(dessertItems, 'dessert-items', 'dessert', 'ice-cream');
            },
            
            renderCategoryItems(items, containerId, category, icon) {
                const container = document.getElementById(containerId);
                
                items.forEach(item => {
                    const button = document.createElement('button');
                    button.className = 'bg-white dark:bg-gray-700 p-3 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600 transition shadow-sm text-left';
                    
                    button.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div class="font-medium truncate">${item.name}</div>
                            <div class="text-${category}"><i class="fas fa-${icon}"></i></div>
                        </div>
                        <div class="text-primary font-bold">$${item.price.toFixed(2)}</div>
                    `;
                    button.dataset.id = item.id;
                    container.appendChild(button);
                });
            },
            
            renderMenuConfigItems() {
                const container = document.getElementById('menu-config-items');
                const noItemsMessage = document.getElementById('no-menu-items');
                
                container.innerHTML = '';
                
                if (this.menuItems.length === 0) {
                    noItemsMessage.classList.remove('hidden');
                } else {
                    noItemsMessage.classList.add('hidden');
                    
                    this.menuItems.forEach(item => {
                        const row = document.createElement('tr');
                        
                        // Map category to display name
                        let categoryDisplay = 'Food';
                        if (item.category === 'beverage') categoryDisplay = 'Beverage';
                        if (item.category === 'dessert') categoryDisplay = 'Dessert';
                        
                        row.innerHTML = `
                            <td class="py-3">${item.name}</td>
                            <td class="py-3">${categoryDisplay}</td>
                            <td class="py-3 text-right">$${item.price.toFixed(2)}</td>
                            <td class="py-3 text-right">
                                <button class="edit-item-btn bg-blue-500 text-white px-2 py-1 rounded-md mr-2 hover:bg-blue-600 transition" data-id="${item.id}">
                                    Edit
                                </button>
                                <button class="delete-item-btn bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 transition" data-id="${item.id}">
                                    Delete
                                </button>
                            </td>
                        `;
                        container.appendChild(row);
                    });
                }
            },
            
            renderOrderItems() {
                const container = document.getElementById('order-items');
                container.innerHTML = '';
                
                this.currentOrder.items.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b dark:border-gray-700';
                    row.innerHTML = `
                        <td class="py-2">${item.name}</td>
                        <td class="py-2 text-center">${item.quantity}</td>
                        <td class="py-2 text-right">$${item.total.toFixed(2)}</td>
                        <td class="py-2 text-right">
                            <button class="remove-item-btn text-red-500 hover:text-red-700" data-id="${item.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    container.appendChild(row);
                });
            },
            
            formatDateTime(isoString) {
                const date = new Date(isoString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            },
            
            renderKitchenOrders() {
                const container = document.getElementById('kitchen-orders');
                const noOrdersMessage = document.getElementById('no-kitchen-orders');
                
                container.innerHTML = '';
                
                if (this.kitchenOrders.length === 0) {
                    noOrdersMessage.classList.remove('hidden');
                } else {
                    noOrdersMessage.classList.add('hidden');
                    
                    this.kitchenOrders.forEach(order => {
                        const orderCard = document.createElement('div');
                        orderCard.className = 'bg-red-50 dark:bg-red-900/20 p-4 rounded-lg border border-red-200 dark:border-red-800';
                        
                        let itemsHtml = '';
                        order.items.forEach(item => {
                            itemsHtml += `
                                <div class="flex justify-between mb-1">
                                    <span>${item.quantity}x ${item.name}</span>
                                    <span>$${item.total.toFixed(2)}</span>
                                </div>
                            `;
                        });
                        
                        orderCard.innerHTML = `
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-lg">${order.id}</h3>
                                <span class="text-sm text-gray-600 dark:text-gray-400">${this.formatDateTime(order.timestamp)}</span>
                            </div>
                            <div class="mb-4">
                                ${itemsHtml}
                            </div>
                            <div class="border-t dark:border-red-800 pt-2 mb-3">
                                <div class="flex justify-between font-bold">
                                    <span>Total:</span>
                                    <span>$${order.total.toFixed(2)}</span>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button class="edit-kitchen-order-btn flex-grow bg-blue-500 text-white py-2 rounded-lg font-semibold hover:bg-blue-600 transition" data-id="${order.id}">
                                    <i class="fas fa-edit mr-1"></i> Edit
                                </button>
                                <button class="complete-order-btn flex-grow bg-kitchen text-white py-2 rounded-lg font-semibold hover:bg-red-600 transition" data-id="${order.id}">
                                    <i class="fas fa-check mr-1"></i> Complete
                                </button>
                            </div>
                        `;
                        
                        container.appendChild(orderCard);
                    });
                }
            },
            
            renderOrderHistory() {
                const container = document.getElementById('history-items');
                const noHistoryMessage = document.getElementById('no-history');
                
                container.innerHTML = '';
                
                if (this.orderHistory.length === 0) {
                    noHistoryMessage.classList.remove('hidden');
                } else {
                    noHistoryMessage.classList.add('hidden');
                    
                    this.orderHistory.forEach(order => {
                        const row = document.createElement('tr');
                        
                        // Format items list
                        const itemsList = order.items.map(item => 
                            `${item.quantity}x ${item.name}`
                        ).join(', ');
                        
                        row.innerHTML = `
                            <td class="py-3">${order.id}</td>
                            <td class="py-3">${this.formatDateTime(order.timestamp)}</td>
                            <td class="py-3">${itemsList}</td>
                            <td class="py-3 text-right font-semibold">$${order.total.toFixed(2)}</td>
                            <td class="py-3 text-right">
                                <button class="edit-history-order-btn bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600 transition" data-id="${order.id}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </td>
                        `;
                        
                        container.appendChild(row);
                    });
                }
                
                // Update the total sales amount
                this.updateHistoryTotalSales();
            },
            
            // Event Listeners
            setupEventListeners() {
                // Online/Offline Event Listeners with better error handling
                window.addEventListener('online', () => {
                    console.log("Browser detected online status");
                    if (!this.isOnline) {
                        this.attemptReconnect();
                    }
                });
                
                window.addEventListener('offline', () => {
                    console.log("Browser detected offline status");
                    this.updateConnectionStatus(false, new Error("Network connection lost"));
                });
                
                // Tab Navigation
                document.getElementById('tab-new-order').addEventListener('click', () => this.showTab('new-order-tab'));
                document.getElementById('tab-kitchen').addEventListener('click', () => this.showTab('kitchen-tab'));
                document.getElementById('tab-history').addEventListener('click', () => this.showTab('history-tab'));
                document.getElementById('tab-config').addEventListener('click', () => this.showTab('config-tab'));
                document.getElementById('tab-summary').addEventListener('click', () => this.showTab('summary-tab'));
                
                // Menu Items - event delegation for all category containers
                document.getElementById('food-items').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (button) {
                        this.addItemToOrder(button.dataset.id);
                    }
                });
                
                document.getElementById('beverage-items').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (button) {
                        this.addItemToOrder(button.dataset.id);
                    }
                });
                
                document.getElementById('dessert-items').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (button) {
                        this.addItemToOrder(button.dataset.id);
                    }
                });
                
                // Order Items
                document.getElementById('order-items').addEventListener('click', (e) => {
                    if (e.target.closest('.remove-item-btn')) {
                        const button = e.target.closest('.remove-item-btn');
                        this.removeItemFromOrder(button.dataset.id);
                    }
                });
                
                // Discount
                document.getElementById('apply-discount').addEventListener('click', () => this.applyDiscount());
                
                // Amount Received
                document.getElementById('amount-received').addEventListener('input', (e) => {
                    const amount = parseFloat(e.target.value);
                    if (!isNaN(amount)) {
                        this.calculateChange(amount);
                    } else {
                        document.getElementById('change').value = '';
                    }
                });
                
                // Order Actions
                document.getElementById('clear-order').addEventListener('click', () => this.clearOrder());
                document.getElementById('confirm-order').addEventListener('click', () => this.confirmOrder());
                
                // Menu Configuration
                document.getElementById('add-item').addEventListener('click', () => {
                    const nameInput = document.getElementById('item-name');
                    const priceInput = document.getElementById('item-price');
                    const categorySelect = document.getElementById('item-category');
                    
                    const name = nameInput.value.trim();
                    const price = parseFloat(priceInput.value);
                    const category = categorySelect.value;
                    
                    if (name && !isNaN(price) && price > 0) {
                        this.addMenuItem(name, price, category);
                        nameInput.value = '';
                        priceInput.value = '';
                    } else {
                        const statusEl = document.getElementById('connection-status');
                        const statusTextEl = document.getElementById('status-text');
                        statusTextEl.textContent = 'Please enter a valid name and price';
                        statusEl.classList.remove('status-online');
                        statusEl.classList.add('status-offline');
                        
                        // Reset after 3 seconds
                        setTimeout(() => {
                            this.updateConnectionStatus(this.isOnline);
                        }, 3000);
                    }
                });
                
                // Menu Config Items
                document.getElementById('menu-config-items').addEventListener('click', (e) => {
                    // Edit Item
                    if (e.target.closest('.edit-item-btn')) {
                        const button = e.target.closest('.edit-item-btn');
                        const id = button.dataset.id;
                        const item = this.menuItems.find(item => item.id === id);
                        
                        if (item) {
                            document.getElementById('edit-item-id').value = item.id;
                            document.getElementById('edit-item-name').value = item.name;
                            document.getElementById('edit-item-price').value = item.price;
                            document.getElementById('edit-item-category').value = item.category || 'food';
                            document.getElementById('edit-modal').classList.remove('hidden');
                        }
                    }
                    
                    // Delete Item
                    if (e.target.closest('.delete-item-btn')) {
                        const button = e.target.closest('.delete-item-btn');
                        // Instead of confirm, show a message in the status area
                        this.deleteMenuItem(button.dataset.id);
                        const statusEl = document.getElementById('connection-status');
                        const statusTextEl = document.getElementById('status-text');
                        statusTextEl.textContent = 'Item deleted successfully';
                        statusEl.classList.remove('status-offline');
                        statusEl.classList.add('status-online');
                        
                        // Reset after 3 seconds
                        setTimeout(() => {
                            this.updateConnectionStatus(this.isOnline);
                        }, 3000);
                    }
                });
                
                // Edit Modal
                document.getElementById('cancel-edit').addEventListener('click', () => {
                    document.getElementById('edit-modal').classList.add('hidden');
                });
                
                document.getElementById('save-edit').addEventListener('click', () => {
                    const id = document.getElementById('edit-item-id').value;
                    const name = document.getElementById('edit-item-name').value.trim();
                    const price = parseFloat(document.getElementById('edit-item-price').value);
                    const category = document.getElementById('edit-item-category').value;
                    
                    if (name && !isNaN(price) && price > 0) {
                        this.updateMenuItem(id, name, price, category);
                        document.getElementById('edit-modal').classList.add('hidden');
                    } else {
                        const statusEl = document.getElementById('connection-status');
                        const statusTextEl = document.getElementById('status-text');
                        statusTextEl.textContent = 'Please enter a valid name and price';
                        statusEl.classList.remove('status-online');
                        statusEl.classList.add('status-offline');
                        
                        // Reset after 3 seconds
                        setTimeout(() => {
                            this.updateConnectionStatus(this.isOnline);
                        }, 3000);
                    }
                });
                
                // Kitchen Orders
                document.getElementById('kitchen-orders').addEventListener('click', (e) => {
                    if (e.target.closest('.complete-order-btn')) {
                        const button = e.target.closest('.complete-order-btn');
                        this.completeOrder(button.dataset.id);
                    }
                    
                    if (e.target.closest('.edit-kitchen-order-btn')) {
                        const button = e.target.closest('.edit-kitchen-order-btn');
                        this.editKitchenOrder(button.dataset.id);
                    }
                });
                
                // Order History
                document.getElementById('history-items').addEventListener('click', (e) => {
                    if (e.target.closest('.edit-history-order-btn')) {
                        const button = e.target.closest('.edit-history-order-btn');
                        this.editHistoryOrder(button.dataset.id);
                    }
                });
                
                // Order Edit Modal
                document.getElementById('edit-order-modal').addEventListener('click', (e) => {
                    // Handle quantity changes
                    if (e.target.closest('.edit-qty-plus')) {
                        const button = e.target.closest('.edit-qty-plus');
                        this.handleEditOrderQtyChange(button.dataset.id, 'add');
                    }
                    
                    if (e.target.closest('.edit-qty-minus')) {
                        const button = e.target.closest('.edit-qty-minus');
                        this.handleEditOrderQtyChange(button.dataset.id, 'subtract');
                    }
                    
                    if (e.target.closest('.edit-remove-item')) {
                        const button = e.target.closest('.edit-remove-item');
                        this.handleEditOrderQtyChange(button.dataset.id, 'remove');
                    }
                });
                
                document.getElementById('edit-discount-percent').addEventListener('input', () => {
                    const orderId = document.getElementById('edit-order-id').value;
                    const orderType = document.getElementById('edit-order-type').value;
                    const discountPercent = parseFloat(document.getElementById('edit-discount-percent').value);
                    
                    // Find the order
                    let orders = orderType === 'kitchen' ? this.kitchenOrders : this.orderHistory;
                    const orderIndex = orders.findIndex(order => order.id === orderId);
                    
                    if (orderIndex !== -1 && !isNaN(discountPercent) && discountPercent >= 0 && discountPercent <= 100) {
                        orders[orderIndex].discountPercent = discountPercent;
                        orders[orderIndex].discount = orders[orderIndex].subtotal * (discountPercent / 100);
                        orders[orderIndex].total = orders[orderIndex].subtotal - orders[orderIndex].discount;
                        
                        // Update display
                        document.getElementById('edit-discount').textContent = '$' + orders[orderIndex].discount.toFixed(2);
                        document.getElementById('edit-total').textContent = '$' + orders[orderIndex].total.toFixed(2);
                    }
                });
                
                document.getElementById('cancel-edit-order').addEventListener('click', () => {
                    document.getElementById('edit-order-modal').classList.add('hidden');
                });
                
                document.getElementById('save-edit-order').addEventListener('click', () => {
                    this.saveEditedOrder();
                });
                
                // CSV Export
                document.getElementById('export-csv').addEventListener('click', () => {
                    this.downloadCSV();
                });
            },
            
            showTab(tabId) {
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.add('hidden');
                });
                
                // Show selected tab
                document.getElementById(tabId).classList.remove('hidden');
                
                // Update active tab button
                document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                    btn.classList.remove('ring-2', 'ring-white', 'ring-opacity-60');
                });
                
                // Get button id based on tabId (remove "-tab" suffix)
                const buttonId = 'tab-' + tabId.replace('-tab', '');
                document.getElementById(buttonId).classList.add('ring-2', 'ring-white', 'ring-opacity-60');
            }
        };
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            POS.init();
        });

        // Proper authentication handling - FIXED duplicate login
        function login() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            
            // Show loading indicator in status
            const statusEl = document.getElementById('connection-status');
            const statusTextEl = document.getElementById('status-text');
            statusTextEl.textContent = 'Logging in...';
            statusEl.classList.remove('status-online');
            statusEl.classList.add('status-offline');
            
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    console.log("✅ Login successful:", userCredential.user.email);
                    statusTextEl.textContent = '✅ Login successful: ' + userCredential.user.email;
                    statusEl.classList.remove('status-offline');
                    statusEl.classList.add('status-online');
                    
                    // Reset the login form
                    document.getElementById('email').value = '';
                    document.getElementById('password').value = '';
                })
                .catch(error => {
                    console.error("🚨 Login error:", error);
                    statusTextEl.textContent = '🚨 Login failed: ' + error.message;
                    statusEl.classList.remove('status-online');
                    statusEl.classList.add('status-offline');
                });
        }

        function logout() {
            firebase.auth().signOut()
                .then(() => {
                    console.log("✅ Logged out.");
                    const statusEl = document.getElementById('connection-status');
                    const statusTextEl = document.getElementById('status-text');
                    statusTextEl.textContent = 'Logged out successfully';
                    statusEl.classList.remove('status-online');
                    statusEl.classList.add('status-offline');
                })
                .catch(error => {
                    console.error("🚨 Logout error:", error);
                });
        }

        // Set up authentication state change listener
        firebase.auth().onAuthStateChanged(user => {
            const appSection = document.getElementById('app-section');
            const authSection = document.getElementById('auth-section');
            const logoutSection = document.getElementById('logout-section');
            
            if (user) {
                console.log("✅ User is logged in:", user.email);
                authSection.style.display = 'none';
                logoutSection.style.display = 'block';
                document.getElementById('user-email').textContent = user.email;
                appSection.classList.remove('hidden');
                
                // Update connection status with user info
                POS.updateConnectionStatus(POS.isOnline);
                
                // Initialize Firebase if needed
                if (!firebaseInitialized) {
                    initializeFirebase();
                }
            } else {
                console.log("🚫 User is NOT logged in");
                authSection.style.display = 'block';
                logoutSection.style.display = 'none';
                appSection.classList.add('hidden');
                
                // Update connection status without user info
                POS.updateConnectionStatus(POS.isOnline);
            }
        });
    </script>
</body>
</html>
