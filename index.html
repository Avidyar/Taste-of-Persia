<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persiche Ecke POS</title>
    
    <!-- Favicon -->
<link rel="shortcut icon" type="image/png" href="https://i.postimg.cc/8z2YqWL9/504325441-17844053133513384-334681923318941997-n-removebg-preview.png">
    
    <!-- Firebase App (core) - SIMPLE VERSION WITH NO APP CHECK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        order: '#3b82f6',
                        kitchen: '#ef4444',
                        completed: '#10b981',
                        config: '#8b5cf6',
                        food: '#e67e22',
                        beverage: '#3498db',
                        dessert: '#9b59b6',
                        persian: {
                            gold: '#D4AF37',
                            dark: '#2C1810',
                            red: '#8B0000'
                        }
                    },
                    fontFamily: {
                        'pos': ['Inter', 'system-ui', 'sans-serif'],
                        'display': ['Roboto', 'system-ui', 'sans-serif']
                    }
                }
            },
            darkMode: 'class',
        }
    </script>
    <style>
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Category headings */
        .category-heading {
            @apply text-lg font-semibold mb-2 mt-4 border-b pb-1;
        }
        
        .food-heading {
            @apply text-food border-food/30;
        }
        
        .beverage-heading {
            @apply text-beverage border-beverage/30;
        }
        
        .dessert-heading {
            @apply text-dessert border-dessert/30;
        }
        
        /* Connection status badge - moved lower */
        #connection-status {
            position: fixed;
            bottom: 5px;
            right: 20px;
            padding: 5px 16px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .status-online {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .status-offline {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        /* Loading indicator */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Fantasy header styles - doubled height */
        .fantasy-header {
            background: linear-gradient(rgba(44, 24, 16, 0.8), rgba(139, 0, 0, 0.9)), url('https://i.postimg.cc/htD8j8Kk/photo-2025-06-22-20-24-58.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
            overflow: hidden;
            min-height: 300px; /* Doubled from 150px */
        }
        
        .fantasy-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at center, transparent 0%, rgba(212, 175, 55, 0.1) 100%);
            pointer-events: none;
        }
        
        .fantasy-text {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 20px rgba(212, 175, 55, 0.3);
            font-family: 'Inter', serif;
            letter-spacing: 2px;
        }
        
        .persian-ornament {
            position: absolute;
            color: rgba(212, 175, 55, 0.3);
            font-size: 3rem;
            animation: float 6s ease-in-out infinite;
        }
        
        .persian-ornament:nth-child(1) { top: 10%; left: 10%; animation-delay: 0s; }
        .persian-ornament:nth-child(2) { top: 20%; right: 15%; animation-delay: 2s; }
        .persian-ornament:nth-child(3) { bottom: 20%; left: 20%; animation-delay: 4s; }
        .persian-ornament:nth-child(4) { bottom: 10%; right: 10%; animation-delay: 1s; }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.5s ease-in-out;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        /* Error log styles */
        .error-log {
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        /* Enhanced POS font styling */
        body {
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 16px;
            line-height: 1.5;
        }

        .pos-text {
            font-family: 'Inter', system-ui, sans-serif;
            font-weight: 500;
        }

        .pos-header {
            font-family: 'Roboto', system-ui, sans-serif;
            font-weight: 700;
        }

        /* Logout section in header */
        .header-logout {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 15px;
            border-radius: 25px;
            color: white;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-gradient-to-b from-yellow-50 via-white to-white dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 text-gray-800 dark:text-gray-200 font-pos">
    
    <!-- Connection Status Indicator - Moved Lower -->
    <div id="connection-status" class="status-offline">
        <span id="status-text">Offline</span>
        <button id="retry-connection" class="ml-2 bg-white bg-opacity-20 px-2 py-1 rounded text-sm">
            Retry
        </button>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <!-- Authentication Section -->
    <div id="auth-section" class="max-w-sm mx-auto p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg mt-10">
        <h2 class="text-xl font-semibold mb-4 text-center pos-header">Login</h2>
        <input type="email" id="email" placeholder="Email" class="w-full p-3 mb-3 border dark:border-gray-600 rounded-lg dark:bg-gray-700 text-base pos-text">
        <input type="password" id="password" placeholder="Password" class="w-full p-3 mb-3 border dark:border-gray-600 rounded-lg dark:bg-gray-700 text-base pos-text">
        <button id="login-button" onclick="login()" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition pos-text">
            <span id="login-button-text">Login</span>
            <span id="login-spinner" class="loading-spinner ml-2 hidden"></span>
        </button>
    </div>
    
    <!-- Main Application Section - Initially hidden -->
    <div id="app-section" class="hidden">
        <div class="container mx-auto px-4 py-8">

            <!-- Fantasy Header with Logout -->
            <header class="mb-8 fantasy-header p-12 rounded-xl shadow-2xl text-center relative">
                <div class="persian-ornament">‚ú¶</div>
                <div class="persian-ornament">‚ùã</div>
                <div class="persian-ornament">‚úß</div>
                <div class="persian-ornament">‚óÜ</div>
                
                <!-- Logout Section in Header -->
                <div id="logout-section" class="header-logout hidden">
                    <span>Logged in as <span id="user-email" class="font-semibold"></span></span>
                    <button onclick="logout()" class="ml-3 bg-red-500 text-white py-1 px-3 rounded-lg font-semibold hover:bg-red-600 transition text-sm">
                        Logout
                    </button>
                </div>
                
                <div class="relative z-10 flex flex-col justify-center h-full">
                    <h1 class="text-6xl font-bold text-white fantasy-text mb-2 pos-header">
                        Taste of Persia
                    </h1>
                    <p class="text-xl text-persian-gold pos-text italic">
                        Where Ancient Flavors Meet Modern Excellence
                    </p>
                    <div class="mt-4 flex justify-center space-x-4 text-persian-gold">
                        <span class="text-2xl">üè∫</span>
                        <span class="text-2xl">‚öú</span>
                        <span class="text-2xl">üåô</span>
                        <span class="text-2xl">‚öú</span>
                        <span class="text-2xl">üè∫</span>
                    </div>
                </div>
            </header>

            <!-- Tab Navigation -->
            <div class="flex flex-wrap mb-6 gap-2">
                <button id="tab-new-order" class="px-4 py-3 rounded-lg bg-order text-white font-semibold flex-grow pos-text"><i class="fas fa-utensils mr-2"></i>New Order</button>
                <button id="tab-kitchen" class="px-4 py-3 rounded-lg bg-kitchen text-white font-semibold flex-grow pos-text"><i class="fas fa-fire mr-2"></i>Kitchen Orders</button>
                <button id="tab-history" class="px-4 py-3 rounded-lg bg-completed text-white font-semibold flex-grow pos-text"><i class="fas fa-history mr-2"></i>Order History</button>
                <button id="tab-config" class="px-4 py-3 rounded-lg bg-config text-white font-semibold flex-grow pos-text"><i class="fas fa-cog mr-2"></i>Menu Config</button>
                <button id="tab-summary" class="px-4 py-3 rounded-lg bg-yellow-600 text-white font-semibold flex-grow pos-text"><i class="fas fa-chart-bar mr-2"></i>Sales Summary</button>
                <button id="tab-logs" class="px-4 py-3 rounded-lg bg-gray-600 text-white font-semibold flex-grow pos-text"><i class="fas fa-bug mr-2"></i>Error Logs</button>
            </div>
            
            <!-- Error Logs Tab -->
            <div id="logs-tab" class="tab-content hidden">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-600 pos-header">Error Logs</h2>
                        <button id="clear-logs" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition pos-text">
                            <i class="fas fa-trash mr-2"></i>Clear Logs
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <button id="export-logs" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition pos-text">
                            <i class="fas fa-download mr-2"></i>Export Logs for AI
                        </button>
                    </div>
                    
                    <div id="error-logs" class="error-log bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <p class="text-gray-500 dark:text-gray-400">No errors logged yet.</p>
                    </div>
                </div>
            </div>
            
            <!-- Sales Summary Tab -->
            <div id="summary-tab" class="tab-content hidden">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-4 text-yellow-600 pos-header">Sales Summary</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-medium mb-2 pos-text">Total Orders</h3>
                            <p id="total-orders-count" class="text-3xl font-bold pos-header">0</p>
                        </div>
                        
                        <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-medium mb-2 pos-text">Total Revenue</h3>
                            <p id="total-revenue" class="text-3xl font-bold pos-header">‚Ç¨0.00</p>
                        </div>
                        
                        <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-medium mb-2 pos-text">Deposit Revenue</h3>
                            <p id="deposit-revenue" class="text-3xl font-bold pos-header">‚Ç¨0.00</p>
                        </div>
                        
                        <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-medium mb-2 pos-text">Average Order Value</h3>
                            <p id="average-order-value" class="text-3xl font-bold pos-header">‚Ç¨0.00</p>
                        </div>
                    </div>
                    
                    <!-- Availability Goals Section -->
                    <div class="mb-8">
                        <h3 class="text-lg font-medium mb-4 pos-header">Availability Goals Progress</h3>
                        <div id="availability-progress" class="space-y-4">
                            <!-- Progress bars will be dynamically inserted here -->
                        </div>
                        <div id="no-availability-data" class="text-center py-8 text-gray-500 dark:text-gray-400">
                            No availability goals set yet
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <h3 class="text-lg font-medium mb-4 pos-header">Top Selling Items</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b dark:border-gray-700">
                                        <th class="text-left py-2 pos-text">Item Name</th>
                                        <th class="text-right py-2 pos-text">Quantity Sold</th>
                                        <th class="text-right py-2 pos-text">Revenue</th>
                                        <th class="text-right py-2 pos-text">Goal Progress</th>
                                    </tr>
                                </thead>
                                <tbody id="top-items" class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Top items will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-top-items" class="text-center py-8 text-gray-500 dark:text-gray-400">
                            No sales data available
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-medium mb-4 pos-header">Data Export</h3>
                        <button id="export-csv" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition pos-text">
                            <i class="fas fa-file-csv mr-2"></i> Export Sales Data (CSV)
                        </button>
                    </div>
                </div>
            </div>

            <!-- New Order Tab -->
            <div id="new-order-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <!-- Menu Items - Increased width -->
                    <div class="lg:col-span-3 bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                        <h2 class="text-xl font-semibold mb-4 text-order pos-header">Menu Items</h2>
                        
                        <div id="menu-items-container" class="overflow-y-auto max-h-[70vh] custom-scrollbar">
                            <!-- Food section -->
                            <h3 class="category-heading food-heading pos-text"><i class="fas fa-utensils mr-2"></i>Food</h3>
                            <div id="food-items" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 mb-4">
                                <!-- Food items will be dynamically inserted here -->
                            </div>
                            
                            <!-- Beverage section -->
                            <h3 class="category-heading beverage-heading pos-text"><i class="fas fa-coffee mr-2"></i>Beverages</h3>
                            <div id="beverage-items" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 mb-4">
                                <!-- Beverage items will be dynamically inserted here -->
                            </div>
                            
                            <!-- Dessert section -->
                            <h3 class="category-heading dessert-heading pos-text"><i class="fas fa-ice-cream mr-2"></i>Desserts</h3>
                            <div id="dessert-items" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
                                <!-- Dessert items will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>

                    <!-- Current Order - Reduced width -->
                    <div class="lg:col-span-1 bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                        <h2 class="text-xl font-semibold mb-4 text-order pos-header">Current Order</h2>
                        
                        <!-- Order Number and Takeaway Toggle -->
                        <div class="mb-4 space-y-3">
                            <div>
                                <label class="block mb-1 text-sm font-medium pos-text">Order Number:</label>
                                <input type="text" id="order-number-display" class="w-full p-2 border dark:border-gray-700 rounded-lg dark:bg-gray-700 text-base font-bold text-center pos-text" readonly>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm font-medium pos-text">Takeaway:</label>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="takeaway-toggle" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                    <span class="ml-3 text-sm font-medium pos-text" id="takeaway-label">Dine In</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Order Notes -->
                        <div class="mb-4">
                            <label for="order-notes" class="block mb-1 text-sm font-medium pos-text">Order Notes:</label>
                            <textarea id="order-notes" rows="2" class="w-full p-2 border dark:border-gray-700 rounded-lg dark:bg-gray-700 text-base pos-text" placeholder="Special instructions..."></textarea>
                        </div>
                        
                        <div class="mb-4 max-h-[250px] overflow-y-auto custom-scrollbar">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b dark:border-gray-700">
                                        <th class="text-left py-2 pos-text">Item</th>
                                        <th class="text-center py-2 pos-text">Qty</th>
                                        <th class="text-right py-2 pos-text">Price</th>
                                        <th class="text-right py-2 pos-text">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="order-items">
                                    <!-- Order items will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Order Summary -->
                        <div class="space-y-2 mb-4 text-sm pos-text">
                            <div class="flex justify-between">
                                <span>Subtotal:</span>
                                <span id="subtotal" class="font-semibold">‚Ç¨0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Discount:</span>
                                <span id="discount" class="font-semibold">‚Ç¨0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Deposit:</span>
                                <span id="deposit-total" class="font-semibold">‚Ç¨0.00</span>
                            </div>
                            <div class="flex justify-between text-base border-t pt-2">
                                <span class="font-bold">Total:</span>
                                <span id="total" class="font-bold">‚Ç¨0.00</span>
                            </div>
                        </div>

                        <!-- Custom Discount Input -->
                        <div class="mb-4 grid grid-cols-3 gap-2">
                            <div class="col-span-1">
                                <label for="discount-percent" class="block mb-1 text-xs pos-text">Discount %:</label>
                                <input type="number" id="discount-percent" class="w-full p-2 border dark:border-gray-700 rounded-lg dark:bg-gray-700 text-base pos-text" min="0" max="100" value="10">
                            </div>
                            <div class="col-span-2">
                                <label class="block mb-1 text-xs opacity-0">Apply</label>
                                <button id="apply-discount" class="w-full bg-yellow-500 text-white py-2 rounded-lg font-semibold hover:bg-yellow-600 transition text-sm pos-text">
                                    Apply Discount
                                </button>
                            </div>
                        </div>

                        <!-- Payment Section - Side by Side -->
                        <div class="mb-4 grid grid-cols-2 gap-2">
                            <div>
                                <label for="amount-received" class="block mb-1 text-sm pos-text">Amount Received:</label>
                                <input type="number" id="amount-received" class="w-full p-2 border dark:border-gray-700 rounded-lg dark:bg-gray-700 text-base pos-text" min="0" step="0.01">
                            </div>
                            <div>
                                <label for="change" class="block mb-1 text-sm pos-text">Change to Return:</label>
                                <input type="text" id="change" class="w-full p-2 border dark:border-gray-700 rounded-lg dark:bg-gray-700 bg-gray-100 dark:bg-gray-800 text-base pos-text" readonly>
                            </div>
                        </div>

                        <!-- Order Actions -->
                        <div class="grid grid-cols-2 gap-2">
                            <button id="clear-order" class="bg-gray-500 text-white py-2 rounded-lg font-semibold hover:bg-gray-600 transition text-sm pos-text">
                                Clear Order
                            </button>
                            <button id="confirm-order" class="bg-order text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition text-sm pos-text">
                                Confirm Order
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kitchen Orders Tab -->
            <div id="kitchen-tab" class="tab-content hidden">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-4 text-kitchen pos-header">Kitchen Orders</h2>
                    <div id="kitchen-orders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Kitchen orders will be dynamically inserted here -->
                    </div>
                    <div id="no-kitchen-orders" class="text-center py-8 text-gray-500 dark:text-gray-400">
                        No pending orders
                    </div>
                </div>
            </div>

            <!-- Order History Tab -->
            <div id="history-tab" class="tab-content hidden">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-4 text-completed pos-header">Order History</h2>
                    <div class="space-y-2 mb-6">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-medium pos-text">Completed Orders</h3>
                            <div class="flex items-center space-x-4">
                                <div class="text-center">
                                    <span class="text-sm pos-text">Total Sales:</span>
                                    <span id="history-total-sales" class="font-bold text-lg pos-header block">‚Ç¨0.00</span>
                                </div>
                                <div class="text-center">
                                    <span class="text-sm pos-text">Deposit Revenue:</span>
                                    <span id="history-deposit-revenue" class="font-bold text-lg pos-header block">‚Ç¨0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b dark:border-gray-700">
                                    <th class="text-left py-2 pos-text">Order ID</th>
                                    <th class="text-left py-2 pos-text">Date & Time</th>
                                    <th class="text-left py-2 pos-text">Type</th>
                                    <th class="text-left py-2 pos-text">Items</th>
                                    <th class="text-left py-2 pos-text">Notes</th>
                                    <th class="text-right py-2 pos-text">Total</th>
                                    <th class="text-right py-2 pos-text">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="history-items" class="divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- History items will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="no-history" class="text-center py-8 text-gray-500 dark:text-gray-400">
                        No order history yet
                    </div>
                </div>
            </div>

            <!-- Menu Configuration Tab -->
            <div id="config-tab" class="tab-content hidden">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-4 text-config pos-header">Menu Configuration</h2>
                    
                    <!-- Add Menu Item Form -->
                    <div class="mb-8 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h3 class="text-lg font-medium mb-4 pos-header">Add New Menu Item</h3>
                        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                            <div class="md:col-span-2">
                                <label for="item-name" class="block mb-2 pos-text">Item Name:</label>
                                <input type="text" id="item-name" class="w-full p-2 border dark:border-gray-600 rounded-lg dark:bg-gray-800 text-base pos-text" placeholder="e.g. Cheeseburger">
                            </div>
                            <div>
                                <label for="item-price" class="block mb-2 pos-text">Price (‚Ç¨):</label>
                                <input type="number" id="item-price" class="w-full p-2 border dark:border-gray-600 rounded-lg dark:bg-gray-800 text-base pos-text" min="0" step="0.01" placeholder="9.99">
                            </div>
                            <div>
                                <label for="item-category" class="block mb-2 pos-text">Category:</label>
                                <select id="item-category" class="w-full p-2 border dark:border-gray-600 rounded-lg dark:bg-gray-800 text-base pos-text">
                                    <option value="food">Food</option>
                                    <option value="beverage">Beverage</option>
                                    <option value="dessert">Dessert</option>
                                </select>
                            </div>
                            <div>
                                <label for="item-availability" class="block mb-2 pos-text">Daily Goal:</label>
                                <input type="number" id="item-availability" class="w-full p-2 border dark:border-gray-600 rounded-lg dark:bg-gray-800 text-base pos-text" min="0" placeholder="50">
                            </div>
                            <div class="flex items-end">
                                <button id="add-item" class="w-full bg-config text-white py-2 rounded-lg font-semibold hover:bg-purple-700 transition pos-text">
                                    Add Item
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Menu Items List -->
                    <h3 class="text-lg font-medium mb-4 pos-header">Current Menu Items</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b dark:border-gray-700">
                                    <th class="text-left py-2 pos-text">Item Name</th>
                                    <th class="text-left py-2 pos-text">Category</th>
                                    <th class="text-right py-2 pos-text">Price</th>
                                    <th class="text-right py-2 pos-text">Daily Goal</th>
                                    <th class="text-right py-2 pos-text">Sold Today</th>
                                    <th class="text-right py-2 pos-text">Progress</th>
                                    <th class="text-right py-2 pos-text">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="menu-config-items" class="divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Menu config items will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="no-menu-items" class="text-center py-8 text-gray-500 dark:text-gray-400">
                        No menu items yet. Add some items above!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Zero Sugar Modal -->
    <div id="zero-sugar-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4 pos-header">Beverage Options</h3>
            <p class="mb-4 pos-text">Would you like this beverage with zero sugar?</p>
            <div class="flex justify-end space-x-3">
                <button id="zero-sugar-no" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition pos-text">
                    Regular
                </button>
                <button id="zero-sugar-yes" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition pos-text">
                    Zero Sugar
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Menu Item Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4 pos-header">Edit Menu Item</h3>
            <input type="hidden" id="edit-item-id">
            <div class="mb-4">
                <label for="edit-item-name" class="block mb-2 pos-text">Item Name:</label>
                <input type="text" id="edit-item-name" class="w-full p-2 border dark:border-gray-700 rounded-lg dark:bg-gray-700 text-base pos-text">
            </div>
            <div class="mb-4">
                <label for="edit-item-price" class="block mb-2 pos-text">Price (‚Ç¨):</label>
                <input type="number" id="edit-item-price" class="w-full p-2 border dark:border-gray-700 rounded-lg dark:bg-gray-700 text-base pos-text" min="0" step="0.01">
            </div>
            <div class="mb-4">
                <label for="edit-item-category" class="block mb-2 pos-text">Category:</label>
                <select id="edit-item-category" class="w-full p-2 border dark:border-gray-700 rounded-lg dark:bg-gray-700 text-base pos-text">
                    <option value="food">Food</option>
                    <option value="beverage">Beverage</option>
                    <option value="dessert">Dessert</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="edit-item-availability" class="block mb-2 pos-text">Daily Goal:</label>
                <input type="number" id="edit-item-availability" class="w-full p-2 border dark:border-gray-700 rounded-lg dark:bg-gray-700 text-base pos-text" min="0">
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-edit" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition pos-text">
                    Cancel
                </button>
                <button id="save-edit" class="px-4 py-2 bg-config text-white rounded-lg hover:bg-purple-700 transition pos-text">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
    
    <!-- Edit Order Modal -->
    <div id="edit-order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg w-full max-w-lg">
            <h3 class="text-lg font-semibold mb-4 pos-header">Edit Order</h3>
            <input type="hidden" id="edit-order-id">
            <input type="hidden" id="edit-order-type">
            
            <div class="mb-4 max-h-[400px] overflow-y-auto custom-scrollbar">
                <table class="w-full">
                    <thead>
                        <tr class="border-b dark:border-gray-700">
                            <th class="text-left py-2 pos-text">Item</th>
                            <th class="text-center py-2 pos-text">Qty</th>
                            <th class="text-right py-2 pos-text">Price</th>
                            <th class="text-right py-2 pos-text">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="edit-order-items">
                        <!-- Order items for editing will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
            
            <div class="space-y-2 mb-4 pos-text">
                <div class="flex justify-between">
                    <span>Subtotal:</span>
                    <span id="edit-subtotal" class="font-semibold">‚Ç¨0.00</span>
                </div>
                <div class="grid grid-cols-3 gap-2 items-center">
                    <div class="col-span-1">
                        <label for="edit-discount-percent" class="text-sm">Discount %:</label>
                        <input type="number" id="edit-discount-percent" class="w-full p-2 border dark:border-gray-700 rounded-lg dark:bg-gray-700 text-base pos-text" min="0" max="100" value="0">
                    </div>
                    <div class="col-span-1 text-right">
                        <span>Discount:</span>
                    </div>
                    <div class="col-span-1 text-right">
                        <span id="edit-discount" class="font-semibold">‚Ç¨0.00</span>
                    </div>
                </div>
                <div class="flex justify-between">
                    <span>Deposit:</span>
                    <span id="edit-deposit" class="font-semibold">‚Ç¨0.00</span>
                </div>
                <div class="flex justify-between text-lg border-t pt-2">
                    <span class="font-bold">Total:</span>
                    <span id="edit-total" class="font-bold">‚Ç¨0.00</span>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button id="cancel-edit-order" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition pos-text">
                    Cancel
                </button>
                <button id="save-edit-order" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition pos-text">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize dark mode based on system preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Error Logging System
        class ErrorLogger {
            constructor() {
                this.logs = [];
                this.maxLogs = 100;
                this.setupGlobalErrorHandling();
            }

            setupGlobalErrorHandling() {
                // Catch unhandled errors
                window.addEventListener('error', (event) => {
                    this.logError('Unhandled Error', {
                        message: event.message,
                        filename: event.filename,
                        lineno: event.lineno,
                        colno: event.colno,
                        stack: event.error ? event.error.stack : 'No stack trace'
                    });
                });

                // Catch unhandled promise rejections
                window.addEventListener('unhandledrejection', (event) => {
                    this.logError('Unhandled Promise Rejection', {
                        reason: event.reason,
                        stack: event.reason ? event.reason.stack : 'No stack trace'
                    });
                });

                // Override console.error to capture manual errors
                const originalConsoleError = console.error;
                console.error = (...args) => {
                    this.logError('Console Error', { message: args.join(' ') });
                    originalConsoleError.apply(console, args);
                };
            }

            logError(type, details) {
                try {
                    const logEntry = {
                        timestamp: new Date().toISOString(),
                        type: type,
                        details: details,
                        userAgent: navigator.userAgent,
                        url: window.location.href,
                        userId: firebase.auth().currentUser ? firebase.auth().currentUser.email : 'Not logged in'
                    };

                    this.logs.unshift(logEntry);
                    
                    // Keep only the most recent logs
                    if (this.logs.length > this.maxLogs) {
                        this.logs = this.logs.slice(0, this.maxLogs);
                    }

                    this.updateLogDisplay();
                    console.log('Error logged:', logEntry);
                } catch (e) {
                    // Fail silently to avoid infinite loops
                    console.warn('Failed to log error:', e);
                }
            }

            updateLogDisplay() {
                const container = document.getElementById('error-logs');
                if (!container) return;

                if (this.logs.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No errors logged yet.</p>';
                    return;
                }

                const logsHtml = this.logs.map(log => `
                    <div class="mb-4 p-3 bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 rounded">
                        <div class="font-semibold text-red-700 dark:text-red-300">${log.type}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">${log.timestamp}</div>
                        <div class="text-sm mt-2">
                            <strong>Details:</strong> ${JSON.stringify(log.details, null, 2)}
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            User: ${log.userId} | URL: ${log.url}
                        </div>
                    </div>
                `).join('');

                container.innerHTML = logsHtml;
            }

            clearLogs() {
                this.logs = [];
                this.updateLogDisplay();
            }

            exportLogs() {
                const exportData = {
                    exportTime: new Date().toISOString(),
                    appVersion: '2.0',
                    totalErrors: this.logs.length,
                    logs: this.logs
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `error_logs_${new Date().toISOString().slice(0, 10)}.json`;
                link.click();
                URL.revokeObjectURL(url);
            }
        }

        // Initialize error logger
        const errorLogger = new ErrorLogger();

        // Notification System
        class NotificationSystem {
            constructor() {
                this.container = document.getElementById('notification-container');
            }

            show(message, type = 'info', duration = 5000) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                this.container.appendChild(notification);
                
                // Trigger animation
                setTimeout(() => notification.classList.add('show'), 100);
                
                // Auto remove
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, duration);
            }

            warning(message) {
                this.show(message, 'warning');
            }

            error(message) {
                this.show(message, 'error');
            }

            success(message) {
                this.show(message, 'success');
            }
        }

        const notifications = new NotificationSystem();

        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyAjEtQ_YZcltxOm_4Tbe-NgFOtVBw6u_zQ",
          authDomain: "persianecke.firebaseapp.com",
          projectId: "persianecke",
          storageBucket: "persianecke.firebasestorage.app",
          messagingSenderId: "241462886109",
          appId: "1:241462886109:web:9865fcbfc61a95996d2534"
        };

        // Initialize Firebase with better error handling
        let db = null;
        let firebaseInitialized = false;
        
        function initializeFirebase() {
            try {
                if (!firebaseInitialized) {
                    firebase.initializeApp(firebaseConfig);
                    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                    
                    db = firebase.firestore();
                    firebaseInitialized = true;
                    console.log("Firebase initialized successfully");
                    return true;
                } else {
                    db = firebase.firestore();
                    return true;
                }
            } catch (error) {
                errorLogger.logError("Firebase Initialization Error", { error: error.message, stack: error.stack });
                return false;
            }
        }
        
        // Initialize Firebase immediately
        initializeFirebase();

        // Data Models
        const POS = {
            menuItems: [],
            currentOrder: {
                items: [],
                subtotal: 0,
                discount: 0,
                deposit: 0,
                total: 0,
                discountApplied: false,
                discountPercent: 10,
                notes: '',
                takeaway: false,
                orderNumber: null
            },
            kitchenOrders: [],
            orderHistory: [],
            orderCounter: 1000,
            isOnline: false,
            reconnectAttempts: 0,
            maxReconnectAttempts: 3,
            pendingBeverageItem: null, // For zero sugar modal
            DEPOSIT_PRICE: 0.25, // ‚Ç¨0.25 deposit for dine-in drinks
            
            // Update connection status function
            updateConnectionStatus(online, error) {
                try {
                    this.isOnline = online;
                    const statusEl = document.getElementById('connection-status');
                    const statusTextEl = document.getElementById('status-text');
                
                    if (online) {
                        statusTextEl.textContent = '‚úÖ Online';
                        statusEl.classList.remove('status-offline');
                        statusEl.classList.add('status-online');
                    } else {
                        if (error) {
                            statusTextEl.textContent = `‚ùå Offline: ${error.message || 'Connection failed'}`;
                        } else {
                            statusTextEl.textContent = '‚ùå Offline';
                        }
                        statusEl.classList.remove('status-online');
                        statusEl.classList.add('status-offline');
                    }
                } catch (e) {
                    errorLogger.logError("Connection Status Update Error", { error: e.message, stack: e.stack });
                }
            },
            
            // Try to reconnect to Firebase
            attemptReconnect() {
                try {
                    if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                        console.log("Max reconnect attempts reached.");
                        return;
                    }
                    
                    this.reconnectAttempts++;
                    
                    const statusTextEl = document.getElementById('status-text');
                    statusTextEl.textContent = `Trying to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`;
                    
                    if (initializeFirebase()) {
                        this.updateConnectionStatus(true);
                        this.setupFirebaseListeners();
                    } else {
                        this.updateConnectionStatus(false, new Error("Reconnection failed"));
                    }
                } catch (e) {
                    errorLogger.logError("Reconnection Attempt Error", { error: e.message, stack: e.stack });
                }
            },
            
            // Generate a unique order ID
            generateOrderId() {
                try {
                    this.orderCounter++;
                    this.saveOrderCounter();
                    return this.orderCounter;
                } catch (e) {
                    errorLogger.logError("Generate Order ID Error", { error: e.message, stack: e.stack });
                    return Date.now(); // Fallback to timestamp
                }
            },
            
            // Save order counter directly to Firestore
            saveOrderCounter() {
                try {
                    if (db && this.isOnline) {
                        db.collection('config').doc('orderCounter').set({
                            counter: this.orderCounter,
                            updatedAt: new Date().toISOString()
                        }).catch(error => {
                            errorLogger.logError("Save Order Counter Error", { error: error.message });
                            this.updateConnectionStatus(false, error);
                        });
                    }
                } catch (e) {
                    errorLogger.logError("Save Order Counter Error", { error: e.message, stack: e.stack });
                }
            },
            
            // Initialize the app
            init() {
                try {
                    this.updateConnectionStatus(navigator.onLine);
                    this.setupEventListeners();
                    this.generateNextOrderNumber();
                    
                    document.getElementById('retry-connection').addEventListener('click', () => {
                        this.attemptReconnect();
                    });
                    
                    if (db) {
                        this.setupFirebaseListeners();
                    }
                } catch (e) {
                    errorLogger.logError("App Initialization Error", { error: e.message, stack: e.stack });
                }
            },

            generateNextOrderNumber() {
                try {
                    const orderNumber = this.generateOrderId();
                    this.currentOrder.orderNumber = orderNumber;
                    document.getElementById('order-number-display').value = `#${orderNumber}`;
                } catch (e) {
                    errorLogger.logError("Generate Next Order Number Error", { error: e.message, stack: e.stack });
                }
            },
            
            // Setup Firebase real-time listeners with improved error handling
            setupFirebaseListeners() {
                try {
                    if (!db) return;
                    
                    // Listen for menu items changes
                    const menuItemsUnsubscribe = db.collection('config').doc('menuItems').onSnapshot(doc => {
                        try {
                            if (doc.exists && doc.data().items) {
                                this.menuItems = doc.data().items;
                                this.renderMenuItems();
                                this.renderMenuConfigItems();
                                this.updateConnectionStatus(true);
                            } else if (!doc.exists) {
                                db.collection('config').doc('menuItems').set({
                                    items: [],
                                    updatedAt: new Date().toISOString()
                                });
                                this.menuItems = [];
                                this.renderMenuItems();
                                this.renderMenuConfigItems();
                            }
                        } catch (e) {
                            errorLogger.logError("Menu Items Listener Processing Error", { error: e.message, stack: e.stack });
                        }
                    }, error => {
                        errorLogger.logError("Menu Items Listener Error", { error: error.message });
                        this.updateConnectionStatus(false, error);
                    });
                    
                    // Listen for kitchen orders changes
                    const kitchenOrdersUnsubscribe = db.collection('kitchenOrders').onSnapshot(snapshot => {
                        try {
                            this.kitchenOrders = [];
                            snapshot.forEach(doc => {
                                this.kitchenOrders.push(doc.data());
                            });
                            this.renderKitchenOrders();
                            this.updateConnectionStatus(true);
                        } catch (e) {
                            errorLogger.logError("Kitchen Orders Listener Processing Error", { error: e.message, stack: e.stack });
                        }
                    }, error => {
                        errorLogger.logError("Kitchen Orders Listener Error", { error: error.message });
                        this.updateConnectionStatus(false, error);
                    });
                    
                    // Listen for order history changes
                    const orderHistoryUnsubscribe = db.collection('orderHistory').onSnapshot(snapshot => {
                        try {
                            this.orderHistory = [];
                            snapshot.forEach(doc => {
                                this.orderHistory.push(doc.data());
                            });
                            this.renderOrderHistory();
                            this.updateSalesStats();
                            this.updateHistoryTotalSales();
                            this.checkAvailabilityAlerts();
                            this.updateConnectionStatus(true);
                        } catch (e) {
                            errorLogger.logError("Order History Listener Processing Error", { error: e.message, stack: e.stack });
                        }
                    }, error => {
                        errorLogger.logError("Order History Listener Error", { error: error.message });
                        this.updateConnectionStatus(false, error);
                    });
                    
                    // Listen for order counter changes
                    const orderCounterUnsubscribe = db.collection('config').doc('orderCounter').onSnapshot(doc => {
                        try {
                            if (doc.exists && doc.data().counter) {
                                this.orderCounter = doc.data().counter;
                            } else if (!doc.exists) {
                                db.collection('config').doc('orderCounter').set({
                                    counter: this.orderCounter,
                                    updatedAt: new Date().toISOString()
                                });
                            }
                        } catch (e) {
                            errorLogger.logError("Order Counter Listener Processing Error", { error: e.message, stack: e.stack });
                        }
                    }, error => {
                        errorLogger.logError("Order Counter Listener Error", { error: error.message });
                        this.updateConnectionStatus(false, error);
                    });
                    
                    this.firebaseUnsubscribes = {
                        menuItems: menuItemsUnsubscribe,
                        kitchenOrders: kitchenOrdersUnsubscribe,
                        orderHistory: orderHistoryUnsubscribe,
                        orderCounter: orderCounterUnsubscribe
                    };
                    
                    this.updateConnectionStatus(true);
                } catch (error) {
                    errorLogger.logError("Firebase Listeners Setup Error", { error: error.message, stack: error.stack });
                    this.updateConnectionStatus(false, error);
                }
            },

            // Check availability alerts (80% warning)
            checkAvailabilityAlerts() {
                try {
                    if (!this.menuItems || this.menuItems.length === 0) return;

                    const today = new Date().toDateString();
                    const todayOrders = this.orderHistory.filter(order => 
                        new Date(order.timestamp).toDateString() === today
                    );

                    // Count sold items for today
                    const soldToday = {};
                    todayOrders.forEach(order => {
                        order.items.forEach(item => {
                            soldToday[item.name] = (soldToday[item.name] || 0) + item.quantity;
                        });
                    });

                    // Check each menu item with availability goal
                    this.menuItems.forEach(menuItem => {
                        if (menuItem.availabilityGoal && menuItem.availabilityGoal > 0) {
                            const sold = soldToday[menuItem.name] || 0;
                            const percentage = (sold / menuItem.availabilityGoal) * 100;
                            
                            if (percentage >= 80 && percentage < 100) {
                                notifications.warning(`‚ö†Ô∏è ${menuItem.name} is 80% sold out! (${sold}/${menuItem.availabilityGoal})`);
                            } else if (percentage >= 100) {
                                notifications.error(`‚ùå ${menuItem.name} has reached its daily goal! (${sold}/${menuItem.availabilityGoal})`);
                            }
                        }
                    });
                } catch (e) {
                    errorLogger.logError("Availability Alerts Check Error", { error: e.message, stack: e.stack });
                }
            },
            
            // Menu item operations
            addMenuItem(name, price, category, availability) {
                try {
                    const id = Date.now().toString();
                    const newItem = { 
                        id, 
                        name, 
                        price: parseFloat(price), 
                        category,
                        availabilityGoal: availability ? parseInt(availability) : 0
                    };
                    
                    this.menuItems.push(newItem);
                    
                    if (db && this.isOnline) {
                        db.collection('config').doc('menuItems').set({
                            items: this.menuItems,
                            updatedAt: new Date().toISOString()
                        }).catch(error => {
                            errorLogger.logError("Add Menu Item Firebase Error", { error: error.message });
                            this.updateConnectionStatus(false, error);
                        });
                    }
                    
                    notifications.success(`‚úÖ Added ${name} to menu`);
                } catch (e) {
                    errorLogger.logError("Add Menu Item Error", { error: e.message, stack: e.stack, item: { name, price, category, availability } });
                    notifications.error(`‚ùå Failed to add menu item: ${e.message}`);
                }
            },
            
            updateMenuItem(id, name, price, category, availability) {
                try {
                    const index = this.menuItems.findIndex(item => item.id === id);
                    if (index !== -1) {
                        this.menuItems[index] = { 
                            id, 
                            name, 
                            price: parseFloat(price), 
                            category,
                            availabilityGoal: availability ? parseInt(availability) : 0
                        };
                        
                        if (db && this.isOnline) {
                            db.collection('config').doc('menuItems').set({
                                items: this.menuItems,
                                updatedAt: new Date().toISOString()
                            }).catch(error => {
                                errorLogger.logError("Update Menu Item Firebase Error", { error: error.message });
                                this.updateConnectionStatus(false, error);
                            });
                        }
                        
                        notifications.success(`‚úÖ Updated ${name}`);
                    }
                } catch (e) {
                    errorLogger.logError("Update Menu Item Error", { error: e.message, stack: e.stack, item: { id, name, price, category, availability } });
                    notifications.error(`‚ùå Failed to update menu item: ${e.message}`);
                }
            },
            
            deleteMenuItem(id) {
                try {
                    const item = this.menuItems.find(item => item.id === id);
                    this.menuItems = this.menuItems.filter(item => item.id !== id);
                    
                    if (db && this.isOnline) {
                        db.collection('config').doc('menuItems').set({
                            items: this.menuItems,
                            updatedAt: new Date().toISOString()
                        }).catch(error => {
                            errorLogger.logError("Delete Menu Item Firebase Error", { error: error.message });
                            this.updateConnectionStatus(false, error);
                        });
                    }
                    
                    notifications.success(`‚úÖ Deleted ${item ? item.name : 'item'} from menu`);
                } catch (e) {
                    errorLogger.logError("Delete Menu Item Error", { error: e.message, stack: e.stack, itemId: id });
                    notifications.error(`‚ùå Failed to delete menu item: ${e.message}`);
                }
            },
            
            // Calculate deposit for drinks
            calculateDeposit() {
                try {
                    if (this.currentOrder.takeaway) {
                        return 0; // No deposit for takeaway
                    }
                    
                    let depositCount = 0;
                    this.currentOrder.items.forEach(item => {
                        if (item.category === 'beverage') {
                            depositCount += item.quantity;
                        }
                    });
                    
                    return depositCount * this.DEPOSIT_PRICE;
                } catch (e) {
                    errorLogger.logError("Calculate Deposit Error", { error: e.message, stack: e.stack });
                    return 0;
                }
            },
            
            // Order operations
            addItemToOrder(id, zeroSugar = false) {
                try {
                    const menuItem = this.menuItems.find(item => item.id === id);
                    if (!menuItem) return;
                    
                    // Check if it's a beverage and needs zero sugar option
                    if (menuItem.category === 'beverage' && zeroSugar === null) {
                        this.pendingBeverageItem = menuItem;
                        document.getElementById('zero-sugar-modal').classList.remove('hidden');
                        return;
                    }
                    
                    const itemKey = `${id}_${zeroSugar}`;
                    const existingItem = this.currentOrder.items.find(item => 
                        item.id === id && item.zeroSugar === zeroSugar
                    );
                    
                    if (existingItem) {
                        existingItem.quantity += 1;
                        existingItem.total = existingItem.quantity * existingItem.price;
                    } else {
                        const displayName = menuItem.category === 'beverage' && zeroSugar ? 
                            `${menuItem.name} (Zero Sugar)` : menuItem.name;
                        
                        this.currentOrder.items.push({
                            id: menuItem.id,
                            name: menuItem.name,
                            displayName: displayName,
                            price: menuItem.price,
                            category: menuItem.category,
                            quantity: 1,
                            total: menuItem.price,
                            zeroSugar: menuItem.category === 'beverage' ? zeroSugar : false
                        });
                    }
                    
                    this.updateOrderTotals();
                    this.renderOrderItems();
                } catch (e) {
                    errorLogger.logError("Add Item to Order Error", { error: e.message, stack: e.stack, itemId: id, zeroSugar });
                    notifications.error(`‚ùå Failed to add item to order: ${e.message}`);
                }
            },
            
            removeItemFromOrder(id, zeroSugar = false) {
                try {
                    const index = this.currentOrder.items.findIndex(item => 
                        item.id === id && item.zeroSugar === zeroSugar
                    );
                    if (index !== -1) {
                        if (this.currentOrder.items[index].quantity > 1) {
                            this.currentOrder.items[index].quantity -= 1;
                            this.currentOrder.items[index].total = this.currentOrder.items[index].quantity * this.currentOrder.items[index].price;
                        } else {
                            this.currentOrder.items.splice(index, 1);
                        }
                        this.updateOrderTotals();
                        this.renderOrderItems();
                    }
                } catch (e) {
                    errorLogger.logError("Remove Item from Order Error", { error: e.message, stack: e.stack, itemId: id, zeroSugar });
                    notifications.error(`‚ùå Failed to remove item from order: ${e.message}`);
                }
            },
            
            updateOrderTotals() {
                try {
                    this.currentOrder.subtotal = this.currentOrder.items.reduce((sum, item) => sum + item.total, 0);
                    
                    if (this.currentOrder.discountApplied) {
                        this.currentOrder.discount = this.currentOrder.subtotal * (this.currentOrder.discountPercent / 100);
                    }
                    
                    // Calculate deposit
                    this.currentOrder.deposit = this.calculateDeposit();
                    
                    this.currentOrder.total = this.currentOrder.subtotal - this.currentOrder.discount + this.currentOrder.deposit;
                    
                    document.getElementById('subtotal').textContent = '‚Ç¨' + this.currentOrder.subtotal.toFixed(2);
                    document.getElementById('discount').textContent = '‚Ç¨' + this.currentOrder.discount.toFixed(2);
                    document.getElementById('deposit-total').textContent = '‚Ç¨' + this.currentOrder.deposit.toFixed(2);
                    document.getElementById('total').textContent = '‚Ç¨' + this.currentOrder.total.toFixed(2);
                    
                    document.getElementById('amount-received').value = '';
                    document.getElementById('change').value = '';
                } catch (e) {
                    errorLogger.logError("Update Order Totals Error", { error: e.message, stack: e.stack });
                }
            },
            
            applyDiscount() {
                try {
                    if (this.currentOrder.items.length > 0) {
                        const discountPercent = parseFloat(document.getElementById('discount-percent').value);
                        if (!isNaN(discountPercent) && discountPercent >= 0 && discountPercent <= 100) {
                            this.currentOrder.discountApplied = true;
                            this.currentOrder.discountPercent = discountPercent;
                            this.currentOrder.discount = this.currentOrder.subtotal * (discountPercent / 100);
                            this.updateOrderTotals();
                            notifications.success(`‚úÖ Applied ${discountPercent}% discount`);
                        } else {
                            notifications.error('‚ùå Please enter a valid discount percentage (0-100)');
                        }
                    } else {
                        notifications.warning('‚ö†Ô∏è Add items to order before applying discount');
                    }
                } catch (e) {
                    errorLogger.logError("Apply Discount Error", { error: e.message, stack: e.stack });
                    notifications.error(`‚ùå Failed to apply discount: ${e.message}`);
                }
            },
            
            calculateChange(amountReceived) {
                try {
                    if (amountReceived >= this.currentOrder.total) {
                        const change = amountReceived - this.currentOrder.total;
                        document.getElementById('change').value = '‚Ç¨' + change.toFixed(2);
                    } else {
                        document.getElementById('change').value = 'Insufficient amount';
                    }
                } catch (e) {
                    errorLogger.logError("Calculate Change Error", { error: e.message, stack: e.stack, amountReceived });
                }
            },
            
            clearOrder() {
                try {
                    this.currentOrder = {
                        items: [],
                        subtotal: 0,
                        discount: 0,
                        deposit: 0,
                        total: 0,
                        discountApplied: false,
                        discountPercent: 10,
                        notes: '',
                        takeaway: false,
                        orderNumber: null
                    };
                    
                    this.generateNextOrderNumber();
                    this.renderOrderItems();
                    this.updateOrderTotals();
                    
                    document.getElementById('amount-received').value = '';
                    document.getElementById('change').value = '';
                    document.getElementById('discount-percent').value = '10';
                    document.getElementById('order-notes').value = '';
                    document.getElementById('takeaway-toggle').checked = false;
                    document.getElementById('takeaway-label').textContent = 'Dine In';
                    
                    notifications.success('‚úÖ Order cleared');
                } catch (e) {
                    errorLogger.logError("Clear Order Error", { error: e.message, stack: e.stack });
                    notifications.error(`‚ùå Failed to clear order: ${e.message}`);
                }
            },
            
            confirmOrder() {
                try {
                    if (this.currentOrder.items.length === 0) {
                        notifications.warning('‚ö†Ô∏è Cannot confirm an empty order');
                        return;
                    }
                    
                    const notes = document.getElementById('order-notes').value.trim();
                    const takeaway = document.getElementById('takeaway-toggle').checked;
                    
                    const newOrder = {
                        id: this.currentOrder.orderNumber,
                        items: [...this.currentOrder.items],
                        subtotal: this.currentOrder.subtotal,
                        discount: this.currentOrder.discount,
                        deposit: this.currentOrder.deposit,
                        discountPercent: this.currentOrder.discountPercent,
                        total: this.currentOrder.total,
                        timestamp: new Date().toISOString(),
                        createdAt: new Date().getTime(),
                        notes: notes,
                        takeaway: takeaway
                    };
                    
                    this.kitchenOrders.push(newOrder);
                    
                    if (db && this.isOnline) {
                        db.collection('kitchenOrders').doc(newOrder.id.toString()).set(newOrder)
                            .then(() => {
                                notifications.success(`‚úÖ Order #${newOrder.id} confirmed`);
                            })
                            .catch(error => {
                                errorLogger.logError("Confirm Order Firebase Error", { error: error.message });
                                this.updateConnectionStatus(false, error);
                                notifications.error(`‚ùå Failed to save order to kitchen: ${error.message}`);
                            });
                    } else {
                        notifications.success(`‚úÖ Order #${newOrder.id} confirmed (offline mode)`);
                    }
                    
                    this.clearOrder();
                } catch (e) {
                    errorLogger.logError("Confirm Order Error", { error: e.message, stack: e.stack });
                    notifications.error(`‚ùå Failed to confirm order: ${e.message}`);
                }
            },
            
            completeOrder(id) {
                try {
                    const index = this.kitchenOrders.findIndex(order => order.id == id);
                    if (index !== -1) {
                        const completedOrder = {
                            ...this.kitchenOrders[index],
                            completedAt: new Date().getTime()
                        };
                        
                        if (db && this.isOnline) {
                            db.runTransaction(transaction => {
                                const kitchenOrderRef = db.collection('kitchenOrders').doc(id.toString());
                                transaction.delete(kitchenOrderRef);
                                
                                const historyOrderRef = db.collection('orderHistory').doc(id.toString());
                                transaction.set(historyOrderRef, completedOrder);
                                
                                return Promise.resolve();
                            }).then(() => {
                                this.orderHistory.unshift(completedOrder);
                                this.kitchenOrders.splice(index, 1);
                                this.renderKitchenOrders();
                                this.renderOrderHistory();
                                this.updateSalesStats();
                                this.updateHistoryTotalSales();
                                notifications.success(`‚úÖ Order #${id} completed`);
                            }).catch(error => {
                                errorLogger.logError("Complete Order Transaction Error", { error: error.message });
                                this.updateConnectionStatus(false, error);
                                notifications.error(`‚ùå Failed to complete order: ${error.message}`);
                            });
                        } else {
                            this.orderHistory.unshift(completedOrder);
                            this.kitchenOrders.splice(index, 1);
                            this.renderKitchenOrders();
                            this.renderOrderHistory();
                            this.updateSalesStats();
                            this.updateHistoryTotalSales();
                            notifications.success(`‚úÖ Order #${id} completed (offline mode)`);
                        }
                    }
                } catch (e) {
                    errorLogger.logError("Complete Order Error", { error: e.message, stack: e.stack, orderId: id });
                    notifications.error(`‚ùå Failed to complete order: ${e.message}`);
                }
            },

            // Edit order functionality
            editOrder(orderId, orderType) {
                try {
                    let order;
                    if (orderType === 'kitchen') {
                        order = this.kitchenOrders.find(o => o.id == orderId);
                    } else {
                        order = this.orderHistory.find(o => o.id == orderId);
                    }
                    
                    if (!order) return;
                    
                    document.getElementById('edit-order-id').value = orderId;
                    document.getElementById('edit-order-type').value = orderType;
                    document.getElementById('edit-discount-percent').value = order.discountPercent || 0;
                    
                    this.renderEditOrderItems(order);
                    this.updateEditOrderTotals(order);
                    
                    document.getElementById('edit-order-modal').classList.remove('hidden');
                } catch (e) {
                    errorLogger.logError("Edit Order Error", { error: e.message, stack: e.stack, orderId, orderType });
                    notifications.error(`‚ùå Failed to edit order: ${e.message}`);
                }
            },

            renderEditOrderItems(order) {
                try {
                    const container = document.getElementById('edit-order-items');
                    container.innerHTML = '';
                    
                    order.items.forEach((item, index) => {
                        const row = document.createElement('tr');
                        row.className = 'border-b dark:border-gray-700';
                        row.innerHTML = `
                            <td class="py-2 pos-text">${item.displayName || item.name}</td>
                            <td class="py-2 text-center">
                                <input type="number" min="1" value="${item.quantity}" 
                                       class="w-16 p-1 border rounded text-center pos-text edit-item-qty" 
                                       data-index="${index}">
                            </td>
                            <td class="py-2 text-right pos-text">‚Ç¨${item.total.toFixed(2)}</td>
                            <td class="py-2 text-right">
                                <button class="remove-edit-item-btn text-red-500 hover:text-red-700" data-index="${index}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        container.appendChild(row);
                    });
                } catch (e) {
                    errorLogger.logError("Render Edit Order Items Error", { error: e.message, stack: e.stack });
                }
            },

            updateEditOrderTotals(order) {
                try {
                    const subtotal = order.items.reduce((sum, item) => sum + item.total, 0);
                    const discountPercent = parseFloat(document.getElementById('edit-discount-percent').value) || 0;
                    const discount = subtotal * (discountPercent / 100);
                    
                    // Calculate deposit for edit
                    let deposit = 0;
                    if (!order.takeaway) {
                        let depositCount = 0;
                        order.items.forEach(item => {
                            if (item.category === 'beverage') {
                                depositCount += item.quantity;
                            }
                        });
                        deposit = depositCount * this.DEPOSIT_PRICE;
                    }
                    
                    const total = subtotal - discount + deposit;
                    
                    document.getElementById('edit-subtotal').textContent = '‚Ç¨' + subtotal.toFixed(2);
                    document.getElementById('edit-discount').textContent = '‚Ç¨' + discount.toFixed(2);
                    document.getElementById('edit-deposit').textContent = '‚Ç¨' + deposit.toFixed(2);
                    document.getElementById('edit-total').textContent = '‚Ç¨' + total.toFixed(2);
                } catch (e) {
                    errorLogger.logError("Update Edit Order Totals Error", { error: e.message, stack: e.stack });
                }
            },

            saveEditOrder() {
                try {
                    const orderId = document.getElementById('edit-order-id').value;
                    const orderType = document.getElementById('edit-order-type').value;
                    
                    let order;
                    let orderArray;
                    let collection;
                    
                    if (orderType === 'kitchen') {
                        orderArray = this.kitchenOrders;
                        collection = 'kitchenOrders';
                    } else {
                        orderArray = this.orderHistory;
                        collection = 'orderHistory';
                    }
                    
                    order = orderArray.find(o => o.id == orderId);
                    if (!order) return;
                    
                    // Update quantities
                    const qtyInputs = document.querySelectorAll('.edit-item-qty');
                    qtyInputs.forEach(input => {
                        const index = parseInt(input.dataset.index);
                        const newQty = parseInt(input.value);
                        if (newQty > 0) {
                            order.items[index].quantity = newQty;
                            order.items[index].total = order.items[index].quantity * order.items[index].price;
                        }
                    });
                    
                    // Update discount
                    const discountPercent = parseFloat(document.getElementById('edit-discount-percent').value) || 0;
                    order.discountPercent = discountPercent;
                    
                    // Recalculate totals
                    order.subtotal = order.items.reduce((sum, item) => sum + item.total, 0);
                    order.discount = order.subtotal * (discountPercent / 100);
                    
                    // Calculate deposit
                    let deposit = 0;
                    if (!order.takeaway) {
                        let depositCount = 0;
                        order.items.forEach(item => {
                            if (item.category === 'beverage') {
                                depositCount += item.quantity;
                            }
                        });
                        deposit = depositCount * this.DEPOSIT_PRICE;
                    }
                    order.deposit = deposit;
                    order.total = order.subtotal - order.discount + order.deposit;
                    
                    if (db && this.isOnline) {
                        db.collection(collection).doc(orderId.toString()).set(order)
                            .then(() => {
                                notifications.success(`‚úÖ Order #${orderId} updated`);
                                document.getElementById('edit-order-modal').classList.add('hidden');
                                if (orderType === 'kitchen') {
                                    this.renderKitchenOrders();
                                } else {
                                    this.renderOrderHistory();
                                    this.updateSalesStats();
                                    this.updateHistoryTotalSales();
                                }
                            })
                            .catch(error => {
                                errorLogger.logError("Save Edit Order Firebase Error", { error: error.message });
                                notifications.error(`‚ùå Failed to update order: ${error.message}`);
                            });
                    } else {
                        notifications.success(`‚úÖ Order #${orderId} updated (offline mode)`);
                        document.getElementById('edit-order-modal').classList.add('hidden');
                    }
                } catch (e) {
                    errorLogger.logError("Save Edit Order Error", { error: e.message, stack: e.stack });
                    notifications.error(`‚ùå Failed to save order changes: ${e.message}`);
                }
            },

            deleteOrder(orderId, orderType) {
                try {
                    if (!confirm(`Are you sure you want to delete order #${orderId}?`)) {
                        return;
                    }
                    
                    let orderArray;
                    let collection;
                    
                    if (orderType === 'kitchen') {
                        orderArray = this.kitchenOrders;
                        collection = 'kitchenOrders';
                    } else {
                        orderArray = this.orderHistory;
                        collection = 'orderHistory';
                    }
                    
                    const index = orderArray.findIndex(o => o.id == orderId);
                    if (index === -1) return;
                    
                    if (db && this.isOnline) {
                        db.collection(collection).doc(orderId.toString()).delete()
                            .then(() => {
                                orderArray.splice(index, 1);
                                notifications.success(`‚úÖ Order #${orderId} deleted`);
                                if (orderType === 'kitchen') {
                                    this.renderKitchenOrders();
                                } else {
                                    this.renderOrderHistory();
                                    this.updateSalesStats();
                                    this.updateHistoryTotalSales();
                                }
                            })
                            .catch(error => {
                                errorLogger.logError("Delete Order Firebase Error", { error: error.message });
                                notifications.error(`‚ùå Failed to delete order: ${error.message}`);
                            });
                    } else {
                        orderArray.splice(index, 1);
                        notifications.success(`‚úÖ Order #${orderId} deleted (offline mode)`);
                    }
                } catch (e) {
                    errorLogger.logError("Delete Order Error", { error: e.message, stack: e.stack, orderId, orderType });
                    notifications.error(`‚ùå Failed to delete order: ${e.message}`);
                }
            },
            
            // Sales statistics
            updateSalesStats() {
                try {
                    if (this.orderHistory.length === 0) {
                        document.getElementById('total-orders-count').textContent = '0';
                        document.getElementById('total-revenue').textContent = '‚Ç¨0.00';
                        document.getElementById('deposit-revenue').textContent = '‚Ç¨0.00';
                        document.getElementById('average-order-value').textContent = '‚Ç¨0.00';
                        document.getElementById('no-top-items').classList.remove('hidden');
                        document.getElementById('top-items').innerHTML = '';
                        this.updateAvailabilityProgress();
                        return;
                    }
                    
                    document.getElementById('total-orders-count').textContent = this.orderHistory.length;
                    
                    const totalRevenue = this.orderHistory.reduce((sum, order) => sum + (order.total - (order.deposit || 0)), 0);
                    const totalDeposit = this.orderHistory.reduce((sum, order) => sum + (order.deposit || 0), 0);
                    
                    document.getElementById('total-revenue').textContent = '‚Ç¨' + totalRevenue.toFixed(2);
                    document.getElementById('deposit-revenue').textContent = '‚Ç¨' + totalDeposit.toFixed(2);
                    
                    const avgOrderValue = totalRevenue / this.orderHistory.length;
                    document.getElementById('average-order-value').textContent = '‚Ç¨' + avgOrderValue.toFixed(2);
                    
                    // Top selling items with goal progress
                    const itemSales = {};
                    
                    this.orderHistory.forEach(order => {
                        order.items.forEach(item => {
                            const key = item.displayName || item.name;
                            if (!itemSales[key]) {
                                itemSales[key] = {
                                    quantity: 0,
                                    revenue: 0,
                                    menuItem: this.menuItems.find(mi => mi.name === item.name)
                                };
                            }
                            
                            itemSales[key].quantity += item.quantity;
                            itemSales[key].revenue += item.total;
                        });
                    });
                    
                    const sortedItems = Object.entries(itemSales)
                        .map(([name, stats]) => ({
                            name,
                            quantity: stats.quantity,
                            revenue: stats.revenue,
                            menuItem: stats.menuItem
                        }))
                        .sort((a, b) => b.quantity - a.quantity);
                    
                    const topItemsContainer = document.getElementById('top-items');
                    topItemsContainer.innerHTML = '';
                    
                    if (sortedItems.length === 0) {
                        document.getElementById('no-top-items').classList.remove('hidden');
                    } else {
                        document.getElementById('no-top-items').classList.add('hidden');
                        
                        sortedItems.slice(0, 10).forEach(item => {
                            const row = document.createElement('tr');
                            
                            let progressDisplay = 'N/A';
                            if (item.menuItem && item.menuItem.availabilityGoal && item.menuItem.availabilityGoal > 0) {
                                const percentage = (item.quantity / item.menuItem.availabilityGoal * 100).toFixed(1);
                                progressDisplay = `${percentage}% (${item.quantity}/${item.menuItem.availabilityGoal})`;
                            }
                            
                            row.innerHTML = `
                                <td class="py-2 pos-text">${item.name}</td>
                                <td class="py-2 text-right pos-text">${item.quantity}</td>
                                <td class="py-2 text-right pos-text">‚Ç¨${item.revenue.toFixed(2)}</td>
                                <td class="py-2 text-right pos-text">${progressDisplay}</td>
                            `;
                            topItemsContainer.appendChild(row);
                        });
                    }
                    
                    this.updateAvailabilityProgress();
                } catch (e) {
                    errorLogger.logError("Update Sales Stats Error", { error: e.message, stack: e.stack });
                }
            },

            updateAvailabilityProgress() {
                try {
                    const container = document.getElementById('availability-progress');
                    const noDataMessage = document.getElementById('no-availability-data');
                    
                    const itemsWithGoals = this.menuItems.filter(item => item.availabilityGoal && item.availabilityGoal > 0);
                    
                    if (itemsWithGoals.length === 0) {
                        noDataMessage.classList.remove('hidden');
                        container.innerHTML = '';
                        return;
                    }
                    
                    noDataMessage.classList.add('hidden');
                    
                    // Calculate today's sales
                    const today = new Date().toDateString();
                    const todayOrders = this.orderHistory.filter(order => 
                        new Date(order.timestamp).toDateString() === today
                    );
                    
                    const soldToday = {};
                    todayOrders.forEach(order => {
                        order.items.forEach(item => {
                            soldToday[item.name] = (soldToday[item.name] || 0) + item.quantity;
                        });
                    });
                    
                    container.innerHTML = '';
                    
                    itemsWithGoals.forEach(item => {
                        const sold = soldToday[item.name] || 0;
                        const percentage = (sold / item.availabilityGoal) * 100;
                        const progressClass = percentage >= 100 ? 'bg-red-500' : percentage >= 80 ? 'bg-yellow-500' : 'bg-green-500';
                        
                        const progressBar = document.createElement('div');
                        progressBar.className = 'mb-4';
                        progressBar.innerHTML = `
                            <div class="flex justify-between mb-1">
                                <span class="font-medium pos-text">${item.name}</span>
                                <span class="pos-text">${sold}/${item.availabilityGoal} (${percentage.toFixed(1)}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                                <div class="${progressClass} h-2.5 rounded-full transition-all duration-300" style="width: ${Math.min(percentage, 100)}%"></div>
                            </div>
                        `;
                        container.appendChild(progressBar);
                    });
                } catch (e) {
                    errorLogger.logError("Update Availability Progress Error", { error: e.message, stack: e.stack });
                }
            },
            
            updateHistoryTotalSales() {
                try {
                    if (this.orderHistory.length === 0) {
                        document.getElementById('history-total-sales').textContent = '‚Ç¨0.00';
                        document.getElementById('history-deposit-revenue').textContent = '‚Ç¨0.00';
                        return;
                    }
                    
                    const totalSales = this.orderHistory.reduce((sum, order) => sum + (order.total - (order.deposit || 0)), 0);
                    const totalDeposit = this.orderHistory.reduce((sum, order) => sum + (order.deposit || 0), 0);
                    
                    document.getElementById('history-total-sales').textContent = '‚Ç¨' + totalSales.toFixed(2);
                    document.getElementById('history-deposit-revenue').textContent = '‚Ç¨' + totalDeposit.toFixed(2);
                } catch (e) {
                    errorLogger.logError("Update History Total Sales Error", { error: e.message, stack: e.stack });
                }
            },
            
            // CSV Export
            downloadCSV() {
                try {
                    let kitchenOrdersCSV = 'Order ID,Date,Time,Type,Items,Notes,Subtotal,Discount,Deposit,Total\n';
                    
                    this.kitchenOrders.forEach(order => {
                        const date = new Date(order.timestamp);
                        const dateFormatted = date.toLocaleDateString();
                        const timeFormatted = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        
                        const itemsList = order.items.map(item => 
                            `${item.quantity}x ${item.displayName || item.name}`
                        ).join('; ');
                        
                        const orderType = order.takeaway ? 'Takeaway' : 'Dine In';
                        const notes = (order.notes || '').replace(/"/g, '""');
                        
                        kitchenOrdersCSV += `${order.id},${dateFormatted},${timeFormatted},${orderType},"${itemsList}","${notes}",${order.subtotal.toFixed(2)},${order.discount.toFixed(2)},${(order.deposit || 0).toFixed(2)},${order.total.toFixed(2)}\n`;
                    });
                    
                    let historyCSV = 'Order ID,Date,Time,Type,Items,Notes,Subtotal,Discount,Deposit,Total\n';
                    
                    this.orderHistory.forEach(order => {
                        const date = new Date(order.timestamp);
                        const dateFormatted = date.toLocaleDateString();
                        const timeFormatted = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        
                        const itemsList = order.items.map(item => 
                            `${item.quantity}x ${item.displayName || item.name}`
                        ).join('; ');
                        
                        const orderType = order.takeaway ? 'Takeaway' : 'Dine In';
                        const notes = (order.notes || '').replace(/"/g, '""');
                        
                        historyCSV += `${order.id},${dateFormatted},${timeFormatted},${orderType},"${itemsList}","${notes}",${order.subtotal.toFixed(2)},${order.discount.toFixed(2)},${(order.deposit || 0).toFixed(2)},${order.total.toFixed(2)}\n`;
                    });
                    
                    const combinedCSV = 
                        "KITCHEN ORDERS\n" + 
                        kitchenOrdersCSV + 
                        "\n\nORDER HISTORY\n" + 
                        historyCSV;
                    
                    const blob = new Blob([combinedCSV], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    
                    const link = document.createElement('a');
                    link.href = url;
                    link.setAttribute('download', 'persiche_ecke_sales_' + new Date().toISOString().slice(0, 10) + '.csv');
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    notifications.success('‚úÖ Sales data exported successfully');
                } catch (e) {
                    errorLogger.logError("Download CSV Error", { error: e.message, stack: e.stack });
                    notifications.error(`‚ùå Failed to export data: ${e.message}`);
                }
            },
            
            // UI Rendering
            renderMenuItems() {
                try {
                    document.getElementById('food-items').innerHTML = '';
                    document.getElementById('beverage-items').innerHTML = '';
                    document.getElementById('dessert-items').innerHTML = '';
                    
                    const foodItems = this.menuItems.filter(item => item.category === 'food');
                    const beverageItems = this.menuItems.filter(item => item.category === 'beverage');
                    const dessertItems = this.menuItems.filter(item => item.category === 'dessert');
                    
                    this.renderCategoryItems(foodItems, 'food-items', 'food', 'utensils');
                    this.renderCategoryItems(beverageItems, 'beverage-items', 'beverage', 'coffee');
                    this.renderCategoryItems(dessertItems, 'dessert-items', 'dessert', 'ice-cream');
                } catch (e) {
                    errorLogger.logError("Render Menu Items Error", { error: e.message, stack: e.stack });
                }
            },
            
            renderCategoryItems(items, containerId, category, icon) {
                try {
                    const container = document.getElementById(containerId);
                    
                    items.forEach(item => {
                        const button = document.createElement('button');
                        button.className = 'bg-white dark:bg-gray-700 p-3 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600 transition shadow-sm text-left';
                        
                        button.innerHTML = `
                            <div class="flex justify-between items-center mb-1">
                                <div class="font-medium text-sm pos-text truncate pr-2" title="${item.name}">${item.name}</div>
                                <div class="text-${category} flex-shrink-0"><i class="fas fa-${icon}"></i></div>
                            </div>
                            <div class="text-primary font-bold pos-text">‚Ç¨${item.price.toFixed(2)}</div>
                        `;
                        button.dataset.id = item.id;
                        container.appendChild(button);
                    });
                } catch (e) {
                    errorLogger.logError("Render Category Items Error", { error: e.message, stack: e.stack, category, containerId });
                }
            },
            
            renderMenuConfigItems() {
                try {
                    const container = document.getElementById('menu-config-items');
                    const noItemsMessage = document.getElementById('no-menu-items');
                    
                    container.innerHTML = '';
                    
                    if (this.menuItems.length === 0) {
                        noItemsMessage.classList.remove('hidden');
                    } else {
                        noItemsMessage.classList.add('hidden');
                        
                        // Calculate today's sales for progress
                        const today = new Date().toDateString();
                        const todayOrders = this.orderHistory.filter(order => 
                            new Date(order.timestamp).toDateString() === today
                        );
                        
                        const soldToday = {};
                        todayOrders.forEach(order => {
                            order.items.forEach(item => {
                                soldToday[item.name] = (soldToday[item.name] || 0) + item.quantity;
                            });
                        });
                        
                        this.menuItems.forEach(item => {
                            const row = document.createElement('tr');
                            
                            let categoryDisplay = 'Food';
                            if (item.category === 'beverage') categoryDisplay = 'Beverage';
                            if (item.category === 'dessert') categoryDisplay = 'Dessert';
                            
                            const sold = soldToday[item.name] || 0;
                            const goal = item.availabilityGoal || 0;
                            const progressDisplay = goal > 0 ? `${((sold / goal) * 100).toFixed(1)}%` : 'N/A';
                            
                            row.innerHTML = `
                                <td class="py-3 pos-text">${item.name}</td>
                                <td class="py-3 pos-text">${categoryDisplay}</td>
                                <td class="py-3 text-right pos-text">‚Ç¨${item.price.toFixed(2)}</td>
                                <td class="py-3 text-right pos-text">${goal || 'Not Set'}</td>
                                <td class="py-3 text-right pos-text">${sold}</td>
                                <td class="py-3 text-right pos-text">${progressDisplay}</td>
                                <td class="py-3 text-right">
                                    <button class="edit-item-btn bg-blue-500 text-white px-2 py-1 rounded-md mr-2 hover:bg-blue-600 transition text-sm pos-text" data-id="${item.id}">
                                        Edit
                                    </button>
                                    <button class="delete-item-btn bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 transition text-sm pos-text" data-id="${item.id}">
                                        Delete
                                    </button>
                                </td>
                            `;
                            container.appendChild(row);
                        });
                    }
                } catch (e) {
                    errorLogger.logError("Render Menu Config Items Error", { error: e.message, stack: e.stack });
                }
            },
            
            renderOrderItems() {
                try {
                    const container = document.getElementById('order-items');
                    container.innerHTML = '';
                    
                    this.currentOrder.items.forEach(item => {
                        const row = document.createElement('tr');
                        row.className = 'border-b dark:border-gray-700';
                        row.innerHTML = `
                            <td class="py-2 pos-text text-xs" title="${item.displayName || item.name}">${(item.displayName || item.name).length > 12 ? (item.displayName || item.name).substring(0, 12) + '...' : (item.displayName || item.name)}</td>
                            <td class="py-2 text-center pos-text text-xs">${item.quantity}</td>
                            <td class="py-2 text-right pos-text text-xs">‚Ç¨${item.total.toFixed(2)}</td>
                            <td class="py-2 text-right">
                                <button class="remove-item-btn text-red-500 hover:text-red-700 text-xs" data-id="${item.id}" data-zero-sugar="${item.zeroSugar}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        container.appendChild(row);
                    });
                } catch (e) {
                    errorLogger.logError("Render Order Items Error", { error: e.message, stack: e.stack });
                }
            },
            
            formatDateTime(isoString) {
                try {
                    const date = new Date(isoString);
                    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } catch (e) {
                    errorLogger.logError("Format DateTime Error", { error: e.message, stack: e.stack, isoString });
                    return 'Invalid Date';
                }
            },
            
            renderKitchenOrders() {
                try {
                    const container = document.getElementById('kitchen-orders');
                    const noOrdersMessage = document.getElementById('no-kitchen-orders');
                    
                    container.innerHTML = '';
                    
                    if (this.kitchenOrders.length === 0) {
                        noOrdersMessage.classList.remove('hidden');
                    } else {
                        noOrdersMessage.classList.add('hidden');
                        
                        this.kitchenOrders.forEach(order => {
                            const orderCard = document.createElement('div');
                            orderCard.className = 'bg-red-50 dark:bg-red-900/20 p-4 rounded-lg border border-red-200 dark:border-red-800';
                            
                            let itemsHtml = '';
                            order.items.forEach(item => {
                                itemsHtml += `
                                    <div class="flex justify-between mb-1">
                                        <span class="pos-text">${item.quantity}x ${item.displayName || item.name}</span>
                                        <span class="pos-text">‚Ç¨${item.total.toFixed(2)}</span>
                                    </div>
                                `;
                            });
                            
                            const orderType = order.takeaway ? 
                                '<span class="inline-block bg-blue-500 text-white px-2 py-1 rounded text-xs font-bold pos-text">TAKEAWAY</span>' :
                                '<span class="inline-block bg-green-500 text-white px-2 py-1 rounded text-xs font-bold pos-text">DINE IN</span>';
                            
                            const notes = order.notes ? 
                                `<div class="mt-2 p-2 bg-yellow-100 dark:bg-yellow-900/20 rounded border-l-4 border-yellow-500">
                                    <strong class="pos-text">Notes:</strong> <span class="pos-text">${order.notes}</span>
                                </div>` : '';

                            const depositInfo = order.deposit && order.deposit > 0 ? 
                                `<div class="flex justify-between text-sm pos-text">
                                    <span>Deposit:</span>
                                    <span>‚Ç¨${order.deposit.toFixed(2)}</span>
                                </div>` : '';
                            
                            orderCard.innerHTML = `
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="font-bold text-lg pos-header">#${order.id}</h3>
                                    <div class="flex flex-col items-end">
                                        ${orderType}
                                        <span class="text-sm text-gray-600 dark:text-gray-400 mt-1 pos-text">${this.formatDateTime(order.timestamp)}</span>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    ${itemsHtml}
                                </div>
                                ${notes}
                                <div class="border-t dark:border-red-800 pt-2 mb-3">
                                    <div class="flex justify-between text-sm pos-text">
                                        <span>Subtotal:</span>
                                        <span>‚Ç¨${order.subtotal.toFixed(2)}</span>
                                    </div>
                                    ${order.discount > 0 ? `<div class="flex justify-between text-sm pos-text">
                                        <span>Discount:</span>
                                        <span>-‚Ç¨${order.discount.toFixed(2)}</span>
                                    </div>` : ''}
                                    ${depositInfo}
                                    <div class="flex justify-between font-bold pos-text">
                                        <span>Total:</span>
                                        <span>‚Ç¨${order.total.toFixed(2)}</span>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button class="edit-order-btn flex-1 bg-blue-500 text-white py-2 rounded-lg font-semibold hover:bg-blue-600 transition text-sm pos-text" data-id="${order.id}" data-type="kitchen">
                                        <i class="fas fa-edit mr-1"></i> Edit
                                    </button>
                                    <button class="delete-order-btn flex-1 bg-gray-500 text-white py-2 rounded-lg font-semibold hover:bg-gray-600 transition text-sm pos-text" data-id="${order.id}" data-type="kitchen">
                                        <i class="fas fa-trash mr-1"></i> Delete
                                    </button>
                                    <button class="complete-order-btn flex-1 bg-kitchen text-white py-2 rounded-lg font-semibold hover:bg-red-600 transition text-sm pos-text" data-id="${order.id}">
                                        <i class="fas fa-check mr-1"></i> Complete
                                    </button>
                                </div>
                            `;
                            
                            container.appendChild(orderCard);
                        });
                    }
                } catch (e) {
                    errorLogger.logError("Render Kitchen Orders Error", { error: e.message, stack: e.stack });
                }
            },
            
            renderOrderHistory() {
                try {
                    const container = document.getElementById('history-items');
                    const noHistoryMessage = document.getElementById('no-history');
                    
                    container.innerHTML = '';
                    
                    if (this.orderHistory.length === 0) {
                        noHistoryMessage.classList.remove('hidden');
                    } else {
                        noHistoryMessage.classList.add('hidden');
                        
                        this.orderHistory.forEach(order => {
                            const row = document.createElement('tr');
                            
                            const itemsList = order.items.map(item => 
                                `${item.quantity}x ${item.displayName || item.name}`
                            ).join(', ');
                            
                            const orderType = order.takeaway ? 
                                '<span class="inline-block bg-blue-500 text-white px-2 py-1 rounded text-xs font-bold pos-text">TAKEAWAY</span>' :
                                '<span class="inline-block bg-green-500 text-white px-2 py-1 rounded text-xs font-bold pos-text">DINE IN</span>';
                            
                            const notes = order.notes || '';
                            
                            row.innerHTML = `
                                <td class="py-3 pos-text">#${order.id}</td>
                                <td class="py-3 pos-text">${this.formatDateTime(order.timestamp)}</td>
                                <td class="py-3">${orderType}</td>
                                <td class="py-3 pos-text">${itemsList}</td>
                                <td class="py-3 max-w-xs truncate pos-text" title="${notes}">${notes}</td>
                                <td class="py-3 text-right font-semibold pos-text">‚Ç¨${order.total.toFixed(2)}</td>
                                <td class="py-3 text-right">
                                    <button class="edit-order-btn bg-blue-500 text-white px-2 py-1 rounded-md mr-1 hover:bg-blue-600 transition text-sm pos-text" data-id="${order.id}" data-type="history">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-order-btn bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 transition text-sm pos-text" data-id="${order.id}" data-type="history">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            
                            container.appendChild(row);
                        });
                    }
                    
                    this.updateHistoryTotalSales();
                } catch (e) {
                    errorLogger.logError("Render Order History Error", { error: e.message, stack: e.stack });
                }
            },
            
            // Event Listeners
            setupEventListeners() {
                try {
                    // Error logs
                    document.getElementById('clear-logs').addEventListener('click', () => {
                        errorLogger.clearLogs();
                        notifications.success('‚úÖ Error logs cleared');
                    });
                    
                    document.getElementById('export-logs').addEventListener('click', () => {
                        errorLogger.exportLogs();
                        notifications.success('‚úÖ Error logs exported');
                    });

                    // Online/Offline Event Listeners
                    window.addEventListener('online', () => {
                        console.log("Browser detected online status");
                        if (!this.isOnline) {
                            this.attemptReconnect();
                        }
                    });
                    
                    window.addEventListener('offline', () => {
                        console.log("Browser detected offline status");
                        this.updateConnectionStatus(false, new Error("Network connection lost"));
                    });
                    
                    // Tab Navigation
                    document.getElementById('tab-new-order').addEventListener('click', () => this.showTab('new-order-tab'));
                    document.getElementById('tab-kitchen').addEventListener('click', () => this.showTab('kitchen-tab'));
                    document.getElementById('tab-history').addEventListener('click', () => this.showTab('history-tab'));
                    document.getElementById('tab-config').addEventListener('click', () => this.showTab('config-tab'));
                    document.getElementById('tab-summary').addEventListener('click', () => this.showTab('summary-tab'));
                    document.getElementById('tab-logs').addEventListener('click', () => this.showTab('logs-tab'));
                    
                    // Takeaway toggle - update deposit calculation
                    document.getElementById('takeaway-toggle').addEventListener('change', (e) => {
                        const label = document.getElementById('takeaway-label');
                        this.currentOrder.takeaway = e.target.checked;
                        label.textContent = e.target.checked ? 'Takeaway' : 'Dine In';
                        this.updateOrderTotals(); // Recalculate deposit
                    });
                    
                    // Zero sugar modal
                    document.getElementById('zero-sugar-yes').addEventListener('click', () => {
                        if (this.pendingBeverageItem) {
                            this.addItemToOrder(this.pendingBeverageItem.id, true);
                            this.pendingBeverageItem = null;
                            document.getElementById('zero-sugar-modal').classList.add('hidden');
                        }
                    });
                    
                    document.getElementById('zero-sugar-no').addEventListener('click', () => {
                        if (this.pendingBeverageItem) {
                            this.addItemToOrder(this.pendingBeverageItem.id, false);
                            this.pendingBeverageItem = null;
                            document.getElementById('zero-sugar-modal').classList.add('hidden');
                        }
                    });
                    
                    // Menu Items - event delegation
                    ['food-items', 'beverage-items', 'dessert-items'].forEach(containerId => {
                        document.getElementById(containerId).addEventListener('click', (e) => {
                            const button = e.target.closest('button');
                            if (button) {
                                const menuItem = this.menuItems.find(item => item.id === button.dataset.id);
                                if (menuItem && menuItem.category === 'beverage') {
                                    this.addItemToOrder(button.dataset.id, null); // null triggers modal
                                } else {
                                    this.addItemToOrder(button.dataset.id, false);
                                }
                            }
                        });
                    });
                    
                    // Order Items
                    document.getElementById('order-items').addEventListener('click', (e) => {
                        if (e.target.closest('.remove-item-btn')) {
                            const button = e.target.closest('.remove-item-btn');
                            const zeroSugar = button.dataset.zeroSugar === 'true';
                            this.removeItemFromOrder(button.dataset.id, zeroSugar);
                        }
                    });
                    
                    // Discount
                    document.getElementById('apply-discount').addEventListener('click', () => this.applyDiscount());
                    
                    // Amount Received
                    document.getElementById('amount-received').addEventListener('input', (e) => {
                        const amount = parseFloat(e.target.value);
                        if (!isNaN(amount)) {
                            this.calculateChange(amount);
                        } else {
                            document.getElementById('change').value = '';
                        }
                    });
                    
                    // Order Actions
                    document.getElementById('clear-order').addEventListener('click', () => this.clearOrder());
                    document.getElementById('confirm-order').addEventListener('click', () => this.confirmOrder());
                    
                    // Menu Configuration
                    document.getElementById('add-item').addEventListener('click', () => {
                        const nameInput = document.getElementById('item-name');
                        const priceInput = document.getElementById('item-price');
                        const categorySelect = document.getElementById('item-category');
                        const availabilityInput = document.getElementById('item-availability');
                        
                        const name = nameInput.value.trim();
                        const price = parseFloat(priceInput.value);
                        const category = categorySelect.value;
                        const availability = parseInt(availabilityInput.value) || 0;
                        
                        if (name && !isNaN(price) && price > 0) {
                            this.addMenuItem(name, price, category, availability);
                            nameInput.value = '';
                            priceInput.value = '';
                            availabilityInput.value = '';
                        } else {
                            notifications.error('‚ùå Please enter a valid name and price');
                        }
                    });
                    
                    // Menu Config Items
                    document.getElementById('menu-config-items').addEventListener('click', (e) => {
                        if (e.target.closest('.edit-item-btn')) {
                            const button = e.target.closest('.edit-item-btn');
                            const id = button.dataset.id;
                            const item = this.menuItems.find(item => item.id === id);
                            
                            if (item) {
                                document.getElementById('edit-item-id').value = item.id;
                                document.getElementById('edit-item-name').value = item.name;
                                document.getElementById('edit-item-price').value = item.price;
                                document.getElementById('edit-item-category').value = item.category || 'food';
                                document.getElementById('edit-item-availability').value = item.availabilityGoal || '';
                                document.getElementById('edit-modal').classList.remove('hidden');
                            }
                        }
                        
                        if (e.target.closest('.delete-item-btn')) {
                            const button = e.target.closest('.delete-item-btn');
                            this.deleteMenuItem(button.dataset.id);
                        }
                    });
                    
                    // Edit Modal
                    document.getElementById('cancel-edit').addEventListener('click', () => {
                        document.getElementById('edit-modal').classList.add('hidden');
                    });
                    
                    document.getElementById('save-edit').addEventListener('click', () => {
                        const id = document.getElementById('edit-item-id').value;
                        const name = document.getElementById('edit-item-name').value.trim();
                        const price = parseFloat(document.getElementById('edit-item-price').value);
                        const category = document.getElementById('edit-item-category').value;
                        const availability = parseInt(document.getElementById('edit-item-availability').value) || 0;
                        
                        if (name && !isNaN(price) && price > 0) {
                            this.updateMenuItem(id, name, price, category, availability);
                            document.getElementById('edit-modal').classList.add('hidden');
                        } else {
                            notifications.error('‚ùå Please enter a valid name and price');
                        }
                    });
                    
                    // Kitchen Orders - Enhanced with edit/delete
                    document.getElementById('kitchen-orders').addEventListener('click', (e) => {
                        if (e.target.closest('.complete-order-btn')) {
                            const button = e.target.closest('.complete-order-btn');
                            this.completeOrder(button.dataset.id);
                        }
                        
                        if (e.target.closest('.edit-order-btn')) {
                            const button = e.target.closest('.edit-order-btn');
                            this.editOrder(button.dataset.id, button.dataset.type);
                        }
                        
                        if (e.target.closest('.delete-order-btn')) {
                            const button = e.target.closest('.delete-order-btn');
                            this.deleteOrder(button.dataset.id, button.dataset.type);
                        }
                    });

                    // Order History - Enhanced with edit/delete
                    document.getElementById('history-items').addEventListener('click', (e) => {
                        if (e.target.closest('.edit-order-btn')) {
                            const button = e.target.closest('.edit-order-btn');
                            this.editOrder(button.dataset.id, button.dataset.type);
                        }
                        
                        if (e.target.closest('.delete-order-btn')) {
                            const button = e.target.closest('.delete-order-btn');
                            this.deleteOrder(button.dataset.id, button.dataset.type);
                        }
                    });

                    // Edit Order Modal
                    document.getElementById('cancel-edit-order').addEventListener('click', () => {
                        document.getElementById('edit-order-modal').classList.add('hidden');
                    });

                    document.getElementById('save-edit-order').addEventListener('click', () => {
                        this.saveEditOrder();
                    });

                    // Edit order items event delegation
                    document.getElementById('edit-order-items').addEventListener('click', (e) => {
                        if (e.target.closest('.remove-edit-item-btn')) {
                            const button = e.target.closest('.remove-edit-item-btn');
                            const index = parseInt(button.dataset.index);
                            const orderId = document.getElementById('edit-order-id').value;
                            const orderType = document.getElementById('edit-order-type').value;
                            
                            let order;
                            if (orderType === 'kitchen') {
                                order = this.kitchenOrders.find(o => o.id == orderId);
                            } else {
                                order = this.orderHistory.find(o => o.id == orderId);
                            }
                            
                            if (order && order.items.length > 1) {
                                order.items.splice(index, 1);
                                this.renderEditOrderItems(order);
                                this.updateEditOrderTotals(order);
                            } else {
                                notifications.warning('‚ö†Ô∏è Cannot remove the last item from order');
                            }
                        }
                    });

                    // Edit order quantity changes
                    document.getElementById('edit-order-items').addEventListener('input', (e) => {
                        if (e.target.classList.contains('edit-item-qty')) {
                            const orderId = document.getElementById('edit-order-id').value;
                            const orderType = document.getElementById('edit-order-type').value;
                            
                            let order;
                            if (orderType === 'kitchen') {
                                order = this.kitchenOrders.find(o => o.id == orderId);
                            } else {
                                order = this.orderHistory.find(o => o.id == orderId);
                            }
                            
                            if (order) {
                                this.updateEditOrderTotals(order);
                            }
                        }
                    });

                    // Edit order discount changes
                    document.getElementById('edit-discount-percent').addEventListener('input', () => {
                        const orderId = document.getElementById('edit-order-id').value;
                        const orderType = document.getElementById('edit-order-type').value;
                        
                        let order;
                        if (orderType === 'kitchen') {
                            order = this.kitchenOrders.find(o => o.id == orderId);
                        } else {
                            order = this.orderHistory.find(o => o.id == orderId);
                        }
                        
                        if (order) {
                            this.updateEditOrderTotals(order);
                        }
                    });
                    
                    // CSV Export
                    document.getElementById('export-csv').addEventListener('click', () => {
                        this.downloadCSV();
                    });
                } catch (e) {
                    errorLogger.logError("Setup Event Listeners Error", { error: e.message, stack: e.stack });
                }
            },
            
            showTab(tabId) {
                try {
                    document.querySelectorAll('.tab-content').forEach(tab => {
                        tab.classList.add('hidden');
                    });
                    
                    document.getElementById(tabId).classList.remove('hidden');
                    
                    document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                        btn.classList.remove('ring-2', 'ring-white', 'ring-opacity-60');
                    });
                    
                    const buttonId = 'tab-' + tabId.replace('-tab', '');
                    document.getElementById(buttonId).classList.add('ring-2', 'ring-white', 'ring-opacity-60');
                } catch (e) {
                    errorLogger.logError("Show Tab Error", { error: e.message, stack: e.stack, tabId });
                }
            }
        };
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            try {
                POS.init();
                
                // Listen for authentication state changes
                firebase.auth().onAuthStateChanged((user) => {
                    const statusEl = document.getElementById('connection-status');
                    const statusTextEl = document.getElementById('status-text');

                    if (user) {
                        statusTextEl.textContent = '‚úÖ Online';
                        statusEl.classList.remove('status-offline');
                        statusEl.classList.add('status-online');
                        document.getElementById('auth-section').classList.add('hidden');
                        document.getElementById('logout-section').classList.remove('hidden');
                        document.getElementById('app-section').classList.remove('hidden');
                        document.getElementById('user-email').textContent = user.email;
                        
                        if (!firebaseInitialized) {
                            initializeFirebase();
                        }
                        POS.setupFirebaseListeners();
                    } else {
                        statusTextEl.textContent = '‚ùå Offline';
                        statusEl.classList.remove('status-online');
                        statusEl.classList.add('status-offline');

                        document.getElementById('auth-section').classList.remove('hidden');
                        document.getElementById('logout-section').classList.add('hidden');
                        document.getElementById('app-section').classList.add('hidden');
                    }
                });
            } catch (e) {
                errorLogger.logError("DOM Content Loaded Error", { error: e.message, stack: e.stack });
            }
        });

        // Authentication handling
        function login() {
            try {
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value.trim();

                document.getElementById('login-button').disabled = true;
                document.getElementById('login-spinner').classList.remove('hidden');
                document.getElementById('login-button-text').textContent = 'Logging in...';

                firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                    .then(() => {
                        return firebase.auth().signInWithEmailAndPassword(email, password);
                    })
                    .then((userCredential) => {
                        const user = userCredential.user;
                        document.getElementById('auth-section').classList.add('hidden');
                        document.getElementById('logout-section').classList.remove('hidden');
                        document.getElementById('app-section').classList.remove('hidden');
                        document.getElementById('user-email').textContent = user.email;
                        POS.updateConnectionStatus(true);
                        notifications.success('‚úÖ Logged in successfully');
                    })
                    .catch((error) => {
                        errorLogger.logError("Login Error", { error: error.message, email });
                        notifications.error(`‚ùå Login failed: ${error.message}`);
                    })
                    .finally(() => {
                        document.getElementById('login-button').disabled = false;
                        document.getElementById('login-spinner').classList.add('hidden');
                        document.getElementById('login-button-text').textContent = 'Login';
                    });
            } catch (e) {
                errorLogger.logError("Login Function Error", { error: e.message, stack: e.stack });
                notifications.error(`‚ùå Login error: ${e.message}`);
            }
        }

        function logout() {
            try {
                firebase.auth().signOut()
                    .then(() => {
                        console.log("‚úÖ Logged out.");
                        notifications.success('‚úÖ Logged out successfully');
                    })
                    .catch(error => {
                        errorLogger.logError("Logout Error", { error: error.message });
                        notifications.error(`‚ùå Logout failed: ${error.message}`);
                    });
            } catch (e) {
                errorLogger.logError("Logout Function Error", { error: e.message, stack: e.stack });
                notifications.error(`‚ùå Logout error: ${e.message}`);
            }
        }
    </script>
</body>
</html>
